-- ========================================================================
-- SCRIPT DE MIGRATION - SANDWICHS VERS ARCHITECTURE COMPOSITE
-- DATE: 2025-01-16
-- RESTAURANT: Pizza Yolo 77 (ID: 1)
-- CAT√âGORIE: SANDWICHS (ID: 3)
--
-- OBJECTIF: Migrer de 11 produits individuels vers 1 produit composite
-- MOD√àLE: Architecture OCV (1 produit avec options en groupes)
-- IDs √Ä MIGRER: 345, 346, 347, 348, 349, 351, 352, 353, 354, 355, 356 (pas 350)
--
-- ARCHITECTURE CIBLE:
-- - 1 produit composite "SANDWICHS"
-- - Groupe "Plats" : 11 sandwichs avec prix individuels
-- - Groupe "Boisson 33CL incluse" : 12 boissons
-- - Groupe "Sauces" : 16 sauces (optionnel)
-- - Groupe "Suppl√©ments" : Potatoes, Frites (+1‚Ç¨, optionnel)
-- - Workflow: universal_workflow_v2 (4 steps)
-- ========================================================================

BEGIN;

-- ========================================================================
-- V√âRIFICATIONS DE S√âCURIT√â
-- ========================================================================

DO $$
DECLARE
    v_category_exists INTEGER;
    v_products_count INTEGER;
BEGIN
    -- V√©rifier que la cat√©gorie SANDWICHS existe pour Pizza Yolo
    SELECT COUNT(*) INTO v_category_exists
    FROM france_menu_categories
    WHERE id = 3
    AND restaurant_id = 1
    AND name = 'SANDWICHS';

    IF v_category_exists = 0 THEN
        RAISE EXCEPTION 'ERREUR: Cat√©gorie SANDWICHS (ID: 3) n''existe pas pour Pizza Yolo (ID: 1)';
    END IF;

    -- V√©rifier que les 11 produits existent
    SELECT COUNT(*) INTO v_products_count
    FROM france_products
    WHERE restaurant_id = 1
    AND category_id = 3
    AND id IN (345, 346, 347, 348, 349, 351, 352, 353, 354, 355, 356);

    IF v_products_count != 11 THEN
        RAISE EXCEPTION 'ERREUR: Nombre de produits SANDWICHS incorrect! Trouv√©: % sur 11', v_products_count;
    END IF;

    RAISE NOTICE 'V√©rifications OK - Cat√©gorie et 11 produits SANDWICHS trouv√©s';
END $$;

-- ========================================================================
-- √âTAPE 1: CR√âATION DU PRODUIT COMPOSITE "SANDWICHS"
-- ========================================================================

-- Cr√©er le produit composite avec workflow universal_workflow_v2
INSERT INTO france_products (
    restaurant_id,
    category_id,
    name,
    product_type,
    workflow_type,
    requires_steps,
    steps_config,
    price_on_site_base,
    price_delivery_base,
    display_order,
    is_active
)
VALUES (
    1,                    -- Pizza Yolo
    3,                    -- SANDWICHS
    'SANDWICHS',          -- Nom du produit composite
    'composite',          -- Type composite
    'universal_workflow_v2', -- Workflow moderne
    true,                 -- N√©cessite des √©tapes
    '{
        "steps": [
            {
                "step": 1,
                "type": "options_selection",
                "prompt": "Choisissez votre sandwich",
                "option_groups": ["Plats"],
                "required": true,
                "max_selections": 1
            },
            {
                "step": 2,
                "type": "options_selection",
                "prompt": "Choisissez votre boisson 33CL incluse",
                "option_groups": ["Boisson 33CL incluse"],
                "required": true,
                "max_selections": 1
            },
            {
                "step": 3,
                "type": "options_selection",
                "prompt": "Suppl√©ments (optionnel)",
                "option_groups": ["Suppl√©ments"],
                "required": false,
                "max_selections": 3
            },
            {
                "step": 4,
                "type": "options_selection",
                "prompt": "Choisissez votre sauce (optionnel)",
                "option_groups": ["Sauces"],
                "required": false,
                "max_selections": 1
            }
        ]
    }'::jsonb,            -- Configuration des 4 steps
    0,                    -- Prix de base 0 (prix dans les options)
    0,                    -- Prix livraison de base 0
    1,                    -- Premier dans la cat√©gorie
    true                  -- Actif
)
RETURNING id;

-- R√©cup√©rer l'ID du produit composite cr√©√©
DO $$
DECLARE
    v_composite_id INTEGER;
BEGIN
    SELECT id INTO v_composite_id
    FROM france_products
    WHERE restaurant_id = 1
    AND category_id = 3
    AND name = 'SANDWICHS'
    AND product_type = 'composite'
    AND is_active = true;

    RAISE NOTICE 'Produit composite SANDWICHS cr√©√© avec ID: %', v_composite_id;

    -- Stocker l'ID dans une variable temporaire pour les prochaines √©tapes
    PERFORM set_config('migration.new_product_id', v_composite_id::text, true);
END $$;

-- ========================================================================
-- √âTAPE 2: CR√âATION DU GROUPE "PLATS" (11 SANDWICHS)
-- ========================================================================

-- Ins√©rer les 11 sandwichs comme options dans le groupe "Plats"
DO $$
DECLARE
    v_product_id INTEGER;
BEGIN
    v_product_id := current_setting('migration.new_product_id')::INTEGER;

    -- 1. LE GREC - 8.00‚Ç¨
    INSERT INTO france_product_options (product_id, option_group, option_name, icon, price_modifier, display_order, is_active, composition)
    VALUES (v_product_id, 'Plats', 'LE GREC', 'üá¨üá∑', 8.00, 1, true,
            '√âminc√©s de kebab, fromage');

    -- 2. L'ESCALOPE - 8.00‚Ç¨
    INSERT INTO france_product_options (product_id, option_group, option_name, icon, price_modifier, display_order, is_active, composition)
    VALUES (v_product_id, 'Plats', 'L''ESCALOPE', 'üçó', 8.00, 2, true,
            'Escalope de poulet, fromage');

    -- 3. LE BUFFALO - 8.50‚Ç¨
    INSERT INTO france_product_options (product_id, option_group, option_name, icon, price_modifier, display_order, is_active, composition)
    VALUES (v_product_id, 'Plats', 'LE BUFFALO', 'ü¶¨', 8.50, 3, true,
            '√âminc√©s de kebab & de poulet');

    -- 4. FOREST - 10.00‚Ç¨
    INSERT INTO france_product_options (product_id, option_group, option_name, icon, price_modifier, display_order, is_active, composition)
    VALUES (v_product_id, 'Plats', 'FOREST', 'üå≤', 10.00, 4, true,
            'Escalope, galette de P.D.T, cheddar, fromage raclette');

    -- 5. LE TANDOORI - 8.00‚Ç¨
    INSERT INTO france_product_options (product_id, option_group, option_name, icon, price_modifier, display_order, is_active, composition)
    VALUES (v_product_id, 'Plats', 'LE TANDOORI', 'üçõ', 8.00, 5, true,
            'Poulet marin√© au tandoori, fromage');

    -- 6. LE BOURSIN - 8.50‚Ç¨
    INSERT INTO france_product_options (product_id, option_group, option_name, icon, price_modifier, display_order, is_active, composition)
    VALUES (v_product_id, 'Plats', 'LE BOURSIN', 'üßÄ', 8.50, 6, true,
            'Escalope de poulet, fromage, boursin');

    -- 7. ROYAL - 9.50‚Ç¨
    INSERT INTO france_product_options (product_id, option_group, option_name, icon, price_modifier, display_order, is_active, composition)
    VALUES (v_product_id, 'Plats', 'ROYAL', 'üëë', 9.50, 7, true,
            'Escalope, cordon bleu, cheddar, crudit√©s');

    -- 8. AM√âRICAIN - 8.50‚Ç¨
    INSERT INTO france_product_options (product_id, option_group, option_name, icon, price_modifier, display_order, is_active, composition)
    VALUES (v_product_id, 'Plats', 'AM√âRICAIN', 'üá∫üá∏', 8.50, 8, true,
            '3 Steaks de 45g, ≈ìuf, fromage');

    -- 9. DU CHEF - 8.50‚Ç¨
    INSERT INTO france_product_options (product_id, option_group, option_name, icon, price_modifier, display_order, is_active, composition)
    VALUES (v_product_id, 'Plats', 'DU CHEF', 'üë®‚Äçüç≥', 8.50, 9, true,
            'Escalope de poulet, sauce gruy√®re, fromage r√¢p√©');

    -- 10. LE RADICAL - 8.50‚Ç¨
    INSERT INTO france_product_options (product_id, option_group, option_name, icon, price_modifier, display_order, is_active, composition)
    VALUES (v_product_id, 'Plats', 'LE RADICAL', '‚ö°', 8.50, 10, true,
            'Steak de 45g, cordon bleu, fromage');

    -- 11. RACLETTE - 9.50‚Ç¨
    INSERT INTO france_product_options (product_id, option_group, option_name, icon, price_modifier, display_order, is_active, composition)
    VALUES (v_product_id, 'Plats', 'RACLETTE', 'üßÄ', 9.50, 11, true,
            '2 steaks, ≈ìufs, galette de P.D.T, cheddar, raclette');

    RAISE NOTICE '11 sandwichs ajout√©s au groupe Plats';
END $$;

-- ========================================================================
-- √âTAPE 3: CR√âATION DU GROUPE "BOISSON 33CL INCLUSE" (12 BOISSONS)
-- ========================================================================

-- Ins√©rer les 12 boissons (identique √† BURGERS)
DO $$
DECLARE
    v_product_id INTEGER;
BEGIN
    v_product_id := current_setting('migration.new_product_id')::INTEGER;

    INSERT INTO france_product_options (product_id, option_group, option_name, icon, price_modifier, display_order, is_active)
    VALUES
        (v_product_id, 'Boisson 33CL incluse', '7 UP', 'ü•§', 0, 1, true),
        (v_product_id, 'Boisson 33CL incluse', '7UP CHERRY', 'üçí', 0, 2, true),
        (v_product_id, 'Boisson 33CL incluse', '7UP TROPICAL', 'üå¥', 0, 3, true),
        (v_product_id, 'Boisson 33CL incluse', 'COCA COLA', 'ü•§', 0, 4, true),
        (v_product_id, 'Boisson 33CL incluse', 'COCA ZERO', '‚ö´', 0, 5, true),
        (v_product_id, 'Boisson 33CL incluse', 'EAU MIN√âRALE', 'üíß', 0, 6, true),
        (v_product_id, 'Boisson 33CL incluse', 'ICE TEA', 'üßã', 0, 7, true),
        (v_product_id, 'Boisson 33CL incluse', 'FANTA', 'üçä', 0, 8, true),
        (v_product_id, 'Boisson 33CL incluse', 'OASIS TROPICAL', 'üßÉ', 0, 9, true),
        (v_product_id, 'Boisson 33CL incluse', 'PERRIER', 'ü´ß', 0, 10, true),
        (v_product_id, 'Boisson 33CL incluse', 'SPRITE', 'ü•§', 0, 11, true),
        (v_product_id, 'Boisson 33CL incluse', 'TROPICO', 'üå¥', 0, 12, true);

    RAISE NOTICE '12 boissons ajout√©es au groupe Boisson 33CL incluse';
END $$;

-- ========================================================================
-- √âTAPE 4: CR√âATION DU GROUPE "SAUCES" (16 SAUCES)
-- ========================================================================

-- Ins√©rer les 16 sauces (identique √† BURGERS)
DO $$
DECLARE
    v_product_id INTEGER;
BEGIN
    v_product_id := current_setting('migration.new_product_id')::INTEGER;

    INSERT INTO france_product_options (product_id, option_group, option_name, icon, price_modifier, display_order, is_active)
    VALUES
        (v_product_id, 'Sauces', 'Mayonnaise', 'üç≥', 0, 1, true),
        (v_product_id, 'Sauces', 'Ketchup', 'üçÖ', 0, 2, true),
        (v_product_id, 'Sauces', 'Alg√©rienne', 'üå∂Ô∏è', 0, 3, true),
        (v_product_id, 'Sauces', 'Poivre', '‚ö´', 0, 4, true),
        (v_product_id, 'Sauces', 'Curry', 'üçõ', 0, 5, true),
        (v_product_id, 'Sauces', 'Samoura√Ø', 'üî•', 0, 6, true),
        (v_product_id, 'Sauces', 'Harissa', 'üå∂Ô∏è', 0, 7, true),
        (v_product_id, 'Sauces', 'Blanche', '‚ö™', 0, 8, true),
        (v_product_id, 'Sauces', 'Biggy', 'üçî', 0, 9, true),
        (v_product_id, 'Sauces', 'Barbecue (BBQ)', 'üçñ', 0, 10, true),
        (v_product_id, 'Sauces', 'Chili Tha√Ø', 'üå∂Ô∏è', 0, 11, true),
        (v_product_id, 'Sauces', 'Andalouse', 'üçÖ', 0, 12, true),
        (v_product_id, 'Sauces', 'Moutarde', 'üåæ', 0, 13, true),
        (v_product_id, 'Sauces', 'Fromag√®re', 'üßÄ', 0, 14, true),
        (v_product_id, 'Sauces', 'Burger', 'üçî', 0, 15, true),
        (v_product_id, 'Sauces', 'Tomate', 'üçÖ', 0, 16, true);

    RAISE NOTICE '16 sauces ajout√©es au groupe Sauces';
END $$;

-- ========================================================================
-- √âTAPE 5: CR√âATION DU GROUPE "SUPPL√âMENTS" (2 OPTIONS)
-- ========================================================================

-- Ins√©rer les 2 suppl√©ments (identique √† BURGERS)
DO $$
DECLARE
    v_product_id INTEGER;
BEGIN
    v_product_id := current_setting('migration.new_product_id')::INTEGER;

    INSERT INTO france_product_options (product_id, option_group, option_name, icon, price_modifier, display_order, is_active)
    VALUES
        (v_product_id, 'Suppl√©ments', 'Potatoes', 'üçü', 1.00, 1, true),
        (v_product_id, 'Suppl√©ments', 'Frites maison', 'üçü', 1.00, 2, true);

    RAISE NOTICE '2 suppl√©ments ajout√©s au groupe Suppl√©ments';
END $$;

-- ========================================================================
-- √âTAPE 6: D√âSACTIVATION DES ANCIENS PRODUITS
-- ========================================================================

-- D√©sactiver les 11 anciens produits individuels (NE PAS SUPPRIMER)
UPDATE france_products
SET is_active = false
WHERE restaurant_id = 1
AND category_id = 3
AND id IN (345, 346, 347, 348, 349, 351, 352, 353, 354, 355, 356);

-- ========================================================================
-- V√âRIFICATIONS POST-MIGRATION
-- ========================================================================

-- V√©rifier la cr√©ation du produit composite
SELECT
    'PRODUIT COMPOSITE CR√â√â' AS info,
    id,
    name,
    product_type,
    workflow_type,
    requires_steps,
    is_active
FROM france_products
WHERE restaurant_id = 1
AND category_id = 3
AND name = 'SANDWICHS'
AND product_type = 'composite';

-- V√©rifier le nombre d'options par groupe
SELECT
    option_group AS "Groupe",
    COUNT(*) AS "Nb options"
FROM france_product_options
WHERE product_id = (
    SELECT id FROM france_products
    WHERE restaurant_id = 1
    AND category_id = 3
    AND name = 'SANDWICHS'
    AND product_type = 'composite'
    LIMIT 1
)
GROUP BY option_group
ORDER BY option_group;

-- V√©rifier que les compositions sont pr√©sentes
SELECT
    option_name AS "Sandwich",
    composition AS "Composition",
    price_modifier AS "Prix sur place",
    (price_modifier + 1.00) AS "Prix livraison (+1‚Ç¨)"
FROM france_product_options
WHERE product_id = (
    SELECT id FROM france_products
    WHERE restaurant_id = 1
    AND category_id = 3
    AND name = 'SANDWICHS'
    AND product_type = 'composite'
    LIMIT 1
)
AND option_group = 'Plats'
ORDER BY display_order;

-- V√©rifier l'√©tat de la cat√©gorie SANDWICHS
SELECT
    '√âTAT FINAL SANDWICHS' AS info,
    COUNT(*) AS nb_produits_total,
    COUNT(*) FILTER (WHERE product_type = 'composite' AND is_active = true) AS nb_composite_actif,
    COUNT(*) FILTER (WHERE product_type = 'composite' AND is_active = false) AS nb_composite_inactif,
    COUNT(*) FILTER (WHERE product_type != 'composite' AND is_active = true) AS nb_individuels_actifs,
    COUNT(*) FILTER (WHERE product_type != 'composite' AND is_active = false) AS nb_individuels_inactifs
FROM france_products
WHERE restaurant_id = 1
AND category_id = 3;

-- V√©rifier que les anciens produits sont d√©sactiv√©s
SELECT
    id,
    name,
    is_active,
    'D√âSACTIV√â (√† supprimer apr√®s test)' AS statut
FROM france_products
WHERE restaurant_id = 1
AND category_id = 3
AND id IN (345, 346, 347, 348, 349, 351, 352, 353, 354, 355, 356)
ORDER BY id;

-- Si tout est OK, valider
COMMIT;

-- En cas de probl√®me, annuler avec: ROLLBACK;

-- ========================================================================
-- R√âSULTAT ATTENDU
-- ========================================================================
--
-- ‚úÖ 1 produit composite "SANDWICHS" cr√©√©
-- ‚úÖ 11 options dans groupe "Plats" (avec compositions)
-- ‚úÖ 12 options dans groupe "Boisson 33CL incluse"
-- ‚úÖ 16 options dans groupe "Sauces"
-- ‚úÖ 2 options dans groupe "Suppl√©ments"
-- ‚úÖ TOTAL: 41 options
-- ‚úÖ Workflow: universal_workflow_v2 (4 steps)
-- ‚úÖ 11 anciens produits d√©sactiv√©s (345-356, sauf 350)
--
-- ========================================================================
