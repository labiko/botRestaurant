<ion-header>
  <ion-toolbar color="primary">
    <ion-title>{{ restaurant?.name || 'Dashboard Restaurant' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="navigateToOrders()" fill="solid" color="light" class="orders-header-btn">
        <ion-icon name="receipt" slot="start"></ion-icon>
        Commandes
      </ion-button>
      <ion-button (click)="navigateToSettings()">
        <ion-icon name="settings"></ion-icon>
      </ion-button>
      <ion-button (click)="logout()">
        <ion-icon name="log-out"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="dashboard-content">
  
  <!-- Loading Skeleton -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-card>
      <ion-card-content>
        <ion-skeleton-text animated style="width: 60%"></ion-skeleton-text>
        <ion-skeleton-text animated></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 40%"></ion-skeleton-text>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!isLoading">
    
    <!-- Statut Restaurant -->
    <div class="status-banner" [class]="'status-' + (currentStatus?.reason || 'unknown')">
      <div class="status-info">
        <ion-icon [name]="getStatusIcon('ouvert')" class="status-icon"></ion-icon>
        <div class="status-text">
          <h3>{{ getStatusLabel('ouvert') }}</h3>
          <p *ngIf="currentStatus?.nextOpenTime">{{ currentStatus.nextOpenTime }}</p>
        </div>
      </div>
      <ion-button fill="clear" (click)="navigateToSettings()">
        Gérer
      </ion-button>
    </div>

    <!-- Cartes KPI -->
    <div class="kpi-grid">
      <div class="kpi-card revenue-today">
        <div class="kpi-header">
          <ion-icon name="cash" class="kpi-icon"></ion-icon>
          <span class="kpi-label">Aujourd'hui</span>
        </div>
        <div class="kpi-value">{{ formatCurrency(revenueStats.today) }}</div>
        <div class="kpi-growth" 
             [class.positive]="revenueStats.growth.daily > 0" 
             [class.negative]="revenueStats.growth.daily < 0">
          <ion-icon [name]="revenueStats.growth.daily > 0 ? 'trending-up' : 'trending-down'"></ion-icon>
          {{ Math.abs(revenueStats.growth.daily) | number:'1.1-1' }}%
        </div>
      </div>

      <div class="kpi-card revenue-month">
        <div class="kpi-header">
          <ion-icon name="calendar" class="kpi-icon"></ion-icon>
          <span class="kpi-label">Ce mois</span>
        </div>
        <div class="kpi-value">{{ formatCurrency(revenueStats.thisMonth) }}</div>
        <div class="kpi-growth" 
             [class.positive]="revenueStats.growth.monthly > 0" 
             [class.negative]="revenueStats.growth.monthly < 0">
          <ion-icon [name]="revenueStats.growth.monthly > 0 ? 'trending-up' : 'trending-down'"></ion-icon>
          {{ Math.abs(revenueStats.growth.monthly) | number:'1.1-1' }}%
        </div>
      </div>

      <div class="kpi-card orders-pending">
        <div class="kpi-header">
          <ion-icon name="time" class="kpi-icon"></ion-icon>
          <span class="kpi-label">En attente</span>
        </div>
        <div class="kpi-value">{{ stats.pending }}</div>
        <div class="kpi-sublabel">commandes</div>
      </div>

      <div class="kpi-card orders-progress">
        <div class="kpi-header">
          <ion-icon name="restaurant" class="kpi-icon"></ion-icon>
          <span class="kpi-label">En cours</span>
        </div>
        <div class="kpi-value">{{ stats.inProgress }}</div>
        <div class="kpi-sublabel">en préparation</div>
      </div>
    </div>

    <!-- Section Graphiques -->
    <div class="charts-section">
      <div class="charts-header">
        <h2>Chiffre d'affaires</h2>
        <ion-segment [(ngModel)]="selectedPeriod" (ionChange)="onPeriodChange($event.detail.value)">
          <ion-segment-button value="day">
            <ion-label>Jour</ion-label>
          </ion-segment-button>
          <ion-segment-button value="week">
            <ion-label>Semaine</ion-label>
          </ion-segment-button>
          <ion-segment-button value="month">
            <ion-label>Mois</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>

      <!-- Graphique principal (semaine et mois) -->
      <div class="chart-container" *ngIf="selectedPeriod !== 'day'">
        <div class="simple-chart">
          <div class="chart-title">Évolution des revenus</div>
          <div class="chart-bars">
            <div 
              class="chart-bar" 
              *ngFor="let point of (selectedPeriod === 'month' ? chartData.monthly : chartData.daily).slice(-7)"
              [style.height.%]="getBarHeight(point.value, selectedPeriod === 'month' ? chartData.monthly : chartData.daily)">
              <div class="bar-value">{{ formatCurrency(point.value) }}</div>
              <div class="bar-label">{{ point.label }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Répartition par heure (onglet JOUR uniquement) -->
      <div class="hourly-chart" *ngIf="selectedPeriod === 'day'">
        <div class="simple-chart">
          <div class="chart-title">Répartition par heure (aujourd'hui)</div>
          <div class="chart-bars">
            <div 
              class="chart-bar" 
              *ngFor="let hour of chartData.daily"
              [style.height.%]="getBarHeight(hour.value, chartData.daily)">
              <div class="bar-value">{{ formatCurrency(hour.value) }}</div>
              <div class="bar-label">{{ hour.label }}</div>
            </div>
          </div>
          <!-- Message si aucune commande aujourd'hui -->
          <div *ngIf="chartData.daily.length === 0" class="no-data-message">
            <p>Aucune commande aujourd'hui</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistiques comparatives -->
    <div class="comparison-stats">
      <h2>Comparaisons</h2>
      <div class="comparison-grid">
        <div class="comparison-item">
          <span class="comparison-label">Hier</span>
          <span class="comparison-value">{{ formatCurrency(revenueStats.yesterday) }}</span>
        </div>
        <div class="comparison-item">
          <span class="comparison-label">Cette semaine</span>
          <span class="comparison-value">{{ formatCurrency(revenueStats.thisWeek) }}</span>
        </div>
        <div class="comparison-item">
          <span class="comparison-label">Mois dernier</span>
          <span class="comparison-value">{{ formatCurrency(revenueStats.lastMonth) }}</span>
        </div>
      </div>
    </div>

    <!-- Actions rapides -->
    <div class="quick-actions">
      <ion-button expand="block" (click)="navigateToOrders()" color="primary" class="orders-btn">
        <ion-icon name="receipt" slot="start"></ion-icon>
        Gestion des commandes
      </ion-button>
      
      <ion-button expand="block" (click)="navigateToAnalytics()" fill="outline" class="analytics-btn">
        <ion-icon name="analytics" slot="start"></ion-icon>
        Voir analyses détaillées
      </ion-button>
    </div>

  </div>
</ion-content>