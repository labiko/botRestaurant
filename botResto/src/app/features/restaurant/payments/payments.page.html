<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Versements & Paiements</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="refreshPayments()">
        <ion-icon name="refresh" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Filter tabs -->
  <ion-toolbar>
    <ion-segment [(ngModel)]="selectedFilter" scrollable>
      <ion-segment-button value="all">
        <ion-label>Tous ({{ getOrderCountByStatus('all') }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="en_attente">
        <ion-label>√Ä encaisser ({{ getOrderCountByStatus('en_attente') }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="paye">
        <ion-label>Encaiss√©s ({{ getOrderCountByStatus('paye') }})</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Loading spinner -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Chargement des paiements...</p>
  </div>

  <!-- Orders list -->
  <div *ngIf="!isLoading">
    <!-- No orders message -->
    <ion-card *ngIf="getFilteredOrders().length === 0" class="no-orders-card">
      <ion-card-content>
        <div class="no-orders-content">
          <ion-icon name="cash-outline" class="no-orders-icon"></ion-icon>
          <h3>Aucun paiement</h3>
          <p>Aucun paiement √† la livraison confirm√© pour le moment.</p>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Payment cards -->
    <ion-card *ngFor="let order of getFilteredOrders()" class="order-card">
      <ion-card-header>
        <div class="order-header">
          <div class="order-info">
            <ion-card-title>#{{ order.numero_commande }}</ion-card-title>
            <ion-card-subtitle>{{ order.client_nom }} ‚Ä¢ {{ formatTime(order.created_at) }}</ion-card-subtitle>
          </div>
          <div class="order-badges">
            <ion-badge [color]="getPaymentStatusColor(order.paiement_statut)" class="status-badge">
              {{ getPaymentStatusText(order.paiement_statut) }}
            </ion-badge>
            <ion-badge [color]="getStatusColor(order.statut)" outline>
              {{ getStatusText(order.statut) }}
            </ion-badge>
          </div>
        </div>
      </ion-card-header>

      <ion-card-content>
        <!-- Order items -->
        <div class="order-items">
          <h4>Articles command√©s:</h4>
          <div *ngFor="let item of order.items" class="item-row">
            <span class="item-name">{{ item.quantite }}x {{ item.nom_plat }}</span>
            <span class="item-price">{{ formatPrice(item.prix_total || (item.prix_unitaire * item.quantite) || 0) }}</span>
          </div>
        </div>

        <!-- Order totals -->
        <div class="order-totals">
          <div class="total-row">
            <span>Sous-total:</span>
            <span>{{ formatPrice(order.sous_total) }}</span>
          </div>
          <div *ngIf="order.frais_livraison > 0" class="total-row">
            <span>Frais de livraison:</span>
            <span>{{ formatPrice(order.frais_livraison) }}</span>
          </div>
          <div class="total-row total-final">
            <span><strong>Total √† encaisser:</strong></span>
            <span><strong>{{ formatPrice(order.total) }}</strong></span>
          </div>
        </div>

        <!-- Delivery information -->
        <div class="delivery-info">
          <h4>Informations livraison:</h4>
          <p><strong>Adresse:</strong> {{ order.adresse_livraison }}</p>
          <p><strong>T√©l√©phone:</strong> {{ order.client_phone }}</p>
          
          <!-- Detailed delivery driver info -->
          <div *ngIf="order.livreur_nom" class="assigned-delivery">
            <ion-card class="driver-info-card">
              <ion-card-header>
                <ion-card-title class="driver-title">
                  <ion-icon name="bicycle" color="primary"></ion-icon>
                  Livreur assign√©
                </ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <div class="driver-details">
                  <p><strong>üë§ Nom:</strong> {{ order.livreur_nom }}</p>
                  <p><strong>üìû T√©l√©phone:</strong> {{ order.livreur_phone }}</p>
                  <p *ngIf="order.assigned_at"><strong>üìÖ Assign√© le:</strong> {{ formatDateTime(order.assigned_at) }}</p>
                  <p *ngIf="order.accepted_by_delivery_at"><strong>‚úÖ Accept√© le:</strong> {{ formatDateTime(order.accepted_by_delivery_at) }}</p>
                </div>
              </ion-card-content>
            </ion-card>
          </div>
          
          <!-- No driver assigned -->
          <div *ngIf="!order.livreur_nom" class="no-driver">
            <ion-item lines="none" class="no-driver-item">
              <ion-icon name="alert-circle" slot="start" color="warning"></ion-icon>
              <ion-label>
                <h3>Aucun livreur assign√©</h3>
                <p>En attente d'assignation d'un livreur</p>
              </ion-label>
            </ion-item>
          </div>
        </div>

        <!-- Order status information -->
        <div class="payment-info">
          <h4>Informations paiement:</h4>
          <p><strong>Mode:</strong> Paiement √† la livraison (cash)</p>
          <p><strong>Cr√©√©e le:</strong> {{ formatDateTime(order.created_at) }}</p>
          <p *ngIf="order.delivered_at"><strong>Livr√©e le:</strong> {{ formatDateTime(order.delivered_at) }}</p>
        </div>

        <!-- Payment actions -->
        <div class="order-actions">
          <!-- For delivery orders with driver - Check versement status -->
          <div *ngIf="order.paiement_mode === 'livraison' && order.livreur_phone && order.paiement_statut === 'paye' && !order.versement_confirmed" class="payment-actions">
            <!-- Show OTP input if requested -->
            <div *ngIf="showOtpInput[order.id]">
              <app-otp-input
                #otpInput
                [driverPhone]="getDriverPhone(order)"
                [isLoading]="otpLoadingStates[order.id]"
                [attempts]="otpAttempts[order.id] || 0"
                [maxAttempts]="3"
                (otpValidated)="onOtpValidated(order.id, $event, otpInput)"
                (regenerateRequested)="onRegenerateOtp(order.id)">
              </app-otp-input>
              
              <ion-button 
                expand="block" 
                fill="outline" 
                color="medium"
                (click)="cancelOtpInput(order.id)"
                class="cancel-otp-button">
                <ion-icon name="close" slot="start"></ion-icon>
                Annuler
              </ion-button>
            </div>
            
            <!-- Show confirmation button if OTP not requested -->
            <div *ngIf="!showOtpInput[order.id]">
              <ion-button 
                expand="block" 
                color="warning" 
                fill="solid"
                [disabled]="otpLoadingStates[order.id]"
                (click)="confirmVersement(order.id)"
                class="versement-button">
                <ion-icon name="lock-closed" slot="start"></ion-icon>
                <span *ngIf="!otpLoadingStates[order.id]">Confirmer versement</span>
                <ion-spinner *ngIf="otpLoadingStates[order.id]" name="crescent"></ion-spinner>
              </ion-button>
            </div>
          </div>

          <!-- For other payment modes -->
          <div *ngIf="order.paiement_mode !== 'livraison' && order.paiement_statut === 'en_attente'" class="payment-actions">
            <ion-button 
              expand="block" 
              color="success" 
              fill="solid"
              (click)="markAsPaid(order.id)"
              class="pay-button">
              <ion-icon name="checkmark-circle" slot="start"></ion-icon>
              Marquer comme pay√©
            </ion-button>
          </div>

          <!-- Payment status badges -->
          <div class="payment-status-badges">
            <!-- Payment received badge -->
            <ion-badge 
              *ngIf="order.paiement_statut === 'paye'" 
              color="success" 
              class="status-badge">
              <ion-icon name="checkmark-circle" slot="start"></ion-icon>
              Paiement encaiss√©
            </ion-badge>
            
            <!-- Versement confirmed badge -->
            <ion-badge 
              *ngIf="order.versement_confirmed" 
              color="primary" 
              class="status-badge">
              <ion-icon name="wallet" slot="start"></ion-icon>
              <div class="badge-content">
                <span>Versement confirm√©</span>
                <small *ngIf="order.versement_otp_validated_at">{{ formatDateTime(order.versement_otp_validated_at) }}</small>
              </div>
            </ion-badge>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Refresh spinner -->
  <ion-refresher slot="fixed" (ionRefresh)="refreshPayments()">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
</ion-content>