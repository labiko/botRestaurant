<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Tableau de bord livreur</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="logout()">
        <ion-icon name="log-out" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Accueil Livreur avec Statut en Ligne -->
  <div class="welcome-section">
    <div class="driver-info">
      <ion-icon name="bicycle" class="driver-icon"></ion-icon>
      <div class="info-text">
        <h2>Salut {{ currentDriver?.firstName }} {{ currentDriver?.lastName }}</h2>
        <p>{{ currentDriver?.restaurantName || 'Restaurant' }} ‚Ä¢ Dashboard livreur France</p>
      </div>
      
      <!-- Toggle Statut En Ligne -->
      <div class="online-status-toggle">
        <div class="status-info">
          <ion-icon [name]="isOnline ? 'radio-button-on' : 'radio-button-off'" 
                    [color]="isOnline ? 'success' : 'medium'" 
                    class="status-icon"></ion-icon>
          <span class="status-text" [class.online]="isOnline" [class.offline]="!isOnline">
            {{ isOnline ? 'En ligne' : 'Hors ligne' }}
          </span>
        </div>
        <ion-toggle 
          [checked]="isOnline" 
          (ionChange)="toggleOnlineStatus()"
          [color]="isOnline ? 'success' : 'medium'"
          class="online-toggle">
        </ion-toggle>
      </div>
    </div>
  </div>

  <!-- Statistiques rapides -->
  <div class="stats-section">
    <ion-grid>
      <ion-row>
        <ion-col size="6">
          <ion-card class="stat-card">
            <ion-card-content>
              <div class="stat-content">
                <ion-icon name="bicycle" class="stat-icon"></ion-icon>
                <div class="stat-text">
                  <h3>{{ todayDeliveries }}</h3>
                  <p>Livraisons aujourd'hui</p>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
        
        <ion-col size="6">
          <ion-card class="stat-card">
            <ion-card-content>
              <div class="stat-content">
                <ion-icon name="time" class="stat-icon pending"></ion-icon>
                <div class="stat-text">
                  <h3>{{ pendingDeliveries }}</h3>
                  <p>En cours</p>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
      
      <ion-row>
        <ion-col size="12">
          <ion-card class="stat-card">
            <ion-card-content>
              <div class="stat-content">
                <ion-icon name="checkmark-circle" class="stat-icon success"></ion-icon>
                <div class="stat-text">
                  <h3>{{ completedDeliveries }}</h3>
                  <p>Livraisons termin√©es</p>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <!-- Onglets -->
  <div class="tabs-section">
    <ion-segment [(ngModel)]="activeTab" (ionChange)="switchTab($event.detail.value)">
      <ion-segment-button value="my-orders">
        <ion-label>Mes commandes</ion-label>
        <ion-badge 
          *ngIf="myOrders.length > 0" 
          color="primary" 
          class="tab-badge">
          {{ myOrders.length }}
        </ion-badge>
      </ion-segment-button>
      <ion-segment-button value="available">
        <ion-label>Disponibles</ion-label>
        <ion-badge 
          *ngIf="availableOrders.length > 0" 
          color="success" 
          class="tab-badge">
          {{ availableOrders.length }}
        </ion-badge>
      </ion-segment-button>
    </ion-segment>
  </div>

  <!-- Mes commandes -->
  <div class="orders-section" *ngIf="activeTab === 'my-orders'">
    <h3>Mes commandes</h3>
    
    <ion-card *ngFor="let order of myOrders" class="order-card-compact">
      <ion-card-content>
        <!-- Vue compacte par d√©faut (PAS de pollution) -->
        <div class="compact-header">
          <div class="compact-title">
            <strong>#{{ order.order_number }}</strong> ‚Ä¢ üí∞ {{ formatPrice(order.total_amount) }}
          </div>
          <ion-badge [color]="getStatusColor(order.status)" class="compact-badge">
            {{ getStatusText(order.status) }}
          </ion-badge>
        </div>
        
        <div class="compact-client">
          üë§ {{ getCustomerName(order) }}
        </div>
        
        <div class="compact-summary">
          üì¶ {{ getItemsCount(order) }} article{{ getItemsCount(order) > 1 ? 's' : '' }} ‚Ä¢ 
          üìç {{ getDeliveryZone(order.delivery_address) }}
        </div>

        <!-- Actions compactes -->
        <div class="compact-actions">
          <ion-button 
            size="small" 
            fill="clear" 
            color="primary"
            (click)="toggleOrderDetail(order)">
            <ion-icon [name]="isOrderExpanded(order) ? 'chevron-up' : 'chevron-down'" slot="start"></ion-icon>
            {{ isOrderExpanded(order) ? 'Masquer' : 'D√©tails' }}
          </ion-button>
          <ion-button 
            *ngFor="let action of order.availableActions"
            size="small" 
            fill="solid" 
            [color]="action.color"
            [disabled]="showOTPInput[order.id] && action.key === 'delivered'"
            (click)="updateOrderStatus(order, action.key)">
            {{ action.label }}
          </ion-button>
        </div>

        <!-- NOUVEAU : Interface OTP moderne avec animation -->
        <div *ngIf="showOTPInput[order.id]" class="otp-inline-container">
          <div class="otp-label">
            <ion-icon name="lock-closed" color="warning"></ion-icon>
            <span>Code de validation client :</span>
          </div>
          <div class="otp-modern-container">
            <div class="otp-digits">
              <input 
                #digit0
                type="number"
                maxlength="1" 
                class="otp-digit"
                (input)="onOTPDigitInput($event, 0, order.id, digit1)"
                (keydown)="onOTPKeyDown($event, 0, order.id, undefined, digit1)">
              <input 
                #digit1
                type="number"
                maxlength="1" 
                class="otp-digit"
                (input)="onOTPDigitInput($event, 1, order.id, digit2)"
                (keydown)="onOTPKeyDown($event, 1, order.id, digit0, digit2)">
              <input 
                #digit2
                type="number"
                maxlength="1" 
                class="otp-digit"
                (input)="onOTPDigitInput($event, 2, order.id, digit3)"
                (keydown)="onOTPKeyDown($event, 2, order.id, digit1, digit3)">
              <input 
                #digit3
                type="number"
                maxlength="1" 
                class="otp-digit"
                (input)="onOTPDigitInput($event, 3, order.id, undefined)"
                (keydown)="onOTPKeyDown($event, 3, order.id, digit2, undefined)">
            </div>
            <div class="otp-actions">
              <ion-button 
                size="small" 
                fill="clear" 
                color="medium"
                (click)="cancelOTPInput(order)">
                <ion-icon name="close" slot="start"></ion-icon>
                Annuler
              </ion-button>
            </div>
          </div>
        </div>

        <!-- ACCORD√âON D√âTAILS (uniquement si d√©velopp√©) -->
        <div class="order-details-accordion" *ngIf="isOrderExpanded(order)">
          <div class="accordion-divider"></div>
          
          <!-- Contact client -->
          <div class="detail-section">
            <div class="detail-row">
              <div class="detail-actions">
                <ion-button 
                  size="small" 
                  fill="outline" 
                  color="primary"
                  (click)="callCustomer(order.phone_number)">
                  <ion-icon name="call" slot="start"></ion-icon>
                  Appeler
                </ion-button>
              </div>
            </div>
          </div>

          <!-- Adresse compl√®te -->
          <div class="detail-section" *ngIf="order.delivery_address">
            <div class="detail-row-vertical">
              <span class="address-display">üìç {{ order.delivery_address }}</span>
              <ion-button 
                size="small" 
                fill="outline" 
                color="success"
                (click)="openDirections(order.delivery_address || '')"
                class="gps-button">
                <ion-icon name="navigate" slot="start"></ion-icon>
                GPS
              </ion-button>
            </div>
          </div>

          <!-- D√âTAILS DES ARTICLES (structure identique restaurant) -->
          <div class="detail-section" *ngIf="hasOrderItems(order)">
            <div class="detail-label">üì¶ Articles command√©s:</div>
            <div class="order-items">
              <div *ngFor="let item of getOrderItems(order)" class="item-card">
                
                <!-- En-t√™te de l'article -->
                <div class="item-header">
                  <div class="item-main">
                    <span class="item-quantity">{{ item.quantity || 1 }}x</span>
                    <span class="item-name">
                      {{ item.name }}
                      <ion-badge *ngIf="item.size_name" color="medium" class="size-badge">{{ item.size_name }}</ion-badge>
                    </span>
                  </div>
                  <span class="item-price">{{ formatPrice(item.total_price || item.price || 0) }}</span>
                </div>

                <!-- D√©tails de composition -->
                <div class="item-details" *ngIf="item.configuration_details && item.configuration_details.length > 0">
                  <div class="composition-list">
                    <ion-chip 
                      *ngFor="let detail of item.configuration_details" 
                      color="tertiary" 
                      outline="true"
                      class="composition-chip">
                      {{ detail }}
                    </ion-chip>
                  </div>
                </div>

                <!-- Options d√©taill√©es -->
                <div class="item-options" *ngIf="item.selected_options && hasSelectedOptions(item.selected_options)">
                  <div *ngFor="let optionGroup of getSelectedOptionsGroups(item.selected_options)" class="option-group">
                    <div class="option-group-header">
                      <ion-icon name="chevron-forward" class="option-icon"></ion-icon>
                      <strong>{{ formatOptionGroupName(optionGroup.groupName) }}:</strong>
                    </div>
                    <div class="option-items">
                      <span 
                        *ngFor="let option of optionGroup.options; let last = last" 
                        class="option-item">
                        {{ option.option_name }}{{ !last ? ', ' : '' }}
                        <ion-badge *ngIf="option.price_modifier > 0" color="warning" class="price-modifier">
                          +{{ formatPrice(option.price_modifier) }}
                        </ion-badge>
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Informations suppl√©mentaires -->
                <div class="item-extras" *ngIf="item.includes_drink || item.composition">
                  <div *ngIf="item.includes_drink" class="extra-info">
                    <ion-icon name="cafe" color="primary"></ion-icon>
                    <span>Boisson incluse</span>
                  </div>
                  <div *ngIf="item.composition" class="extra-info">
                    <ion-icon name="information-circle" color="medium"></ion-icon>
                    <span>{{ item.composition }}</span>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- Instructions sp√©ciales -->
          <div class="detail-section" *ngIf="order.notes">
            <div class="detail-label">üìù Instructions:</div>
            <div class="notes-content">{{ order.notes }}</div>
          </div>

          <!-- Heure commande -->
          <div class="detail-section">
            <div class="detail-row">
              <span class="detail-label">üïí Command√© √†:</span>
              <span class="time-display">{{ formatTime(order.created_at) }}</span>
            </div>
          </div>

          <!-- Temps de mise √† jour (si r√©cent) -->
          <div class="detail-section" *ngIf="shouldShowUpdateTime(order)">
            <div class="detail-row">
              <span class="detail-label">üîÑ Mis √† jour:</span>
              <span class="update-time-display">{{ getUpdateTimeText(order) }}</span>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Message si pas de commandes -->
    <ion-card *ngIf="myOrders.length === 0 && !isLoading" class="empty-state-card">
      <ion-card-content class="text-center">
        <div class="empty-state-icon">
          <ion-icon name="bicycle" color="primary"></ion-icon>
        </div>
        <h3 class="empty-state-title">Aucune commande en cours</h3>
        <p class="empty-state-subtitle">
          Vos prochaines livraisons appara√Ætront ici.<br>
          Activez le mode en ligne pour recevoir des commandes !
        </p>
        <ion-button 
          *ngIf="!isOnline"
          fill="outline" 
          color="primary"
          size="small"
          (click)="toggleOnlineStatus()">
          <ion-icon name="power" slot="start"></ion-icon>
          Se mettre en ligne
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Commandes disponibles -->
  <div class="orders-section" *ngIf="activeTab === 'available'">
    <h3>Commandes disponibles</h3>
    
    <ion-card *ngFor="let order of availableOrders" class="order-card-compact">
      <ion-card-content>
        <!-- Vue compacte par d√©faut -->
        <div class="compact-header">
          <div class="compact-title">
            <strong>#{{ order.order_number }}</strong> ‚Ä¢ üí∞ {{ formatPrice(order.total_amount) }}
          </div>
          <ion-badge color="success" class="compact-badge">
            Pr√™te pour livraison
          </ion-badge>
        </div>
        
        <div class="compact-client">
          üë§ {{ getCustomerName(order) }}
        </div>
        
        <div class="compact-summary">
          üì¶ {{ getItemsCount(order) }} article{{ getItemsCount(order) > 1 ? 's' : '' }} ‚Ä¢ 
          üìç {{ getDeliveryZone(order.delivery_address) }}
        </div>

        <!-- Actions compactes -->
        <div class="compact-actions">
          <ion-button 
            size="small" 
            fill="clear" 
            color="primary"
            (click)="toggleOrderDetail(order)">
            <ion-icon [name]="isOrderExpanded(order) ? 'chevron-up' : 'chevron-down'" slot="start"></ion-icon>
            {{ isOrderExpanded(order) ? 'Masquer' : 'D√©tails' }}
          </ion-button>
          <ion-button 
            size="small" 
            fill="solid" 
            color="success"
            (click)="acceptOrder(order)">
            <ion-icon name="checkmark" slot="start"></ion-icon>
            Accepter
          </ion-button>
        </div>

        <!-- ACCORD√âON D√âTAILS -->
        <div class="order-details-accordion" *ngIf="isOrderExpanded(order)">
          <div class="accordion-divider"></div>
          
          <!-- Contact client -->
          <div class="detail-section">
            <div class="detail-row">
              <div class="detail-actions">
                <ion-button 
                  size="small" 
                  fill="outline" 
                  color="primary"
                  (click)="callCustomer(order.phone_number)">
                  <ion-icon name="call" slot="start"></ion-icon>
                  Appeler
                </ion-button>
              </div>
            </div>
          </div>

          <!-- Adresse compl√®te -->
          <div class="detail-section" *ngIf="order.delivery_address">
            <div class="detail-row-vertical">
              <span class="address-display">üìç {{ order.delivery_address }}</span>
              <ion-button 
                size="small" 
                fill="outline" 
                color="success"
                (click)="openDirections(order.delivery_address || '')"
                class="gps-button">
                <ion-icon name="navigate" slot="start"></ion-icon>
                GPS
              </ion-button>
            </div>
          </div>

          <!-- D√âTAILS DES ARTICLES (structure identique restaurant) -->
          <div class="detail-section" *ngIf="hasOrderItems(order)">
            <div class="detail-label">üì¶ Articles command√©s:</div>
            <div class="order-items">
              <div *ngFor="let item of getOrderItems(order)" class="item-card">
                
                <!-- En-t√™te de l'article -->
                <div class="item-header">
                  <div class="item-main">
                    <span class="item-quantity">{{ item.quantity || 1 }}x</span>
                    <span class="item-name">
                      {{ item.name }}
                      <ion-badge *ngIf="item.size_name" color="medium" class="size-badge">{{ item.size_name }}</ion-badge>
                    </span>
                  </div>
                  <span class="item-price">{{ formatPrice(item.total_price || item.price || 0) }}</span>
                </div>

                <!-- D√©tails de composition -->
                <div class="item-details" *ngIf="item.configuration_details && item.configuration_details.length > 0">
                  <div class="composition-list">
                    <ion-chip 
                      *ngFor="let detail of item.configuration_details" 
                      color="tertiary" 
                      outline="true"
                      class="composition-chip">
                      {{ detail }}
                    </ion-chip>
                  </div>
                </div>

                <!-- Options d√©taill√©es -->
                <div class="item-options" *ngIf="item.selected_options && hasSelectedOptions(item.selected_options)">
                  <div *ngFor="let optionGroup of getSelectedOptionsGroups(item.selected_options)" class="option-group">
                    <div class="option-group-header">
                      <ion-icon name="chevron-forward" class="option-icon"></ion-icon>
                      <strong>{{ formatOptionGroupName(optionGroup.groupName) }}:</strong>
                    </div>
                    <div class="option-items">
                      <span 
                        *ngFor="let option of optionGroup.options; let last = last" 
                        class="option-item">
                        {{ option.option_name }}{{ !last ? ', ' : '' }}
                        <ion-badge *ngIf="option.price_modifier > 0" color="warning" class="price-modifier">
                          +{{ formatPrice(option.price_modifier) }}
                        </ion-badge>
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Informations suppl√©mentaires -->
                <div class="item-extras" *ngIf="item.includes_drink || item.composition">
                  <div *ngIf="item.includes_drink" class="extra-info">
                    <ion-icon name="cafe" color="primary"></ion-icon>
                    <span>Boisson incluse</span>
                  </div>
                  <div *ngIf="item.composition" class="extra-info">
                    <ion-icon name="information-circle" color="medium"></ion-icon>
                    <span>{{ item.composition }}</span>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- Instructions sp√©ciales -->
          <div class="detail-section" *ngIf="order.notes">
            <div class="detail-label">üìù Instructions:</div>
            <div class="notes-content">{{ order.notes }}</div>
          </div>

          <!-- Heure commande -->
          <div class="detail-section">
            <div class="detail-row">
              <span class="detail-label">üïí Command√© √†:</span>
              <span class="time-display">{{ formatTime(order.created_at) }}</span>
            </div>
          </div>

          <!-- Temps de mise √† jour (si r√©cent) -->
          <div class="detail-section" *ngIf="shouldShowUpdateTime(order)">
            <div class="detail-row">
              <span class="detail-label">üîÑ Mis √† jour:</span>
              <span class="update-time-display">{{ getUpdateTimeText(order) }}</span>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Message si pas de commandes disponibles -->
    <ion-card *ngIf="availableOrders.length === 0 && !isLoading" class="empty-state-card">
      <ion-card-content class="text-center">
        <div class="empty-state-icon">
          <ion-icon name="notifications" color="success"></ion-icon>
        </div>
        <h3 class="empty-state-title">Aucune commande disponible</h3>
        <p class="empty-state-subtitle">
          Les nouvelles commandes pr√™tes pour livraison<br>
          appara√Ætront ici automatiquement.
        </p>
        <ion-chip color="success" outline="true">
          <ion-icon name="checkmark-circle"></ion-icon>
          <ion-label>Syst√®me actif</ion-label>
        </ion-chip>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Loading -->
  <div class="loading-section" *ngIf="isLoading">
    <ion-card>
      <ion-card-content class="text-center">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Chargement des commandes...</p>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
