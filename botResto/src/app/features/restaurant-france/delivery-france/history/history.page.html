<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>Historique</ion-title>
    <ion-buttons slot="start">
      <!-- Toggle Statut En Ligne -->
      <div class="header-online-toggle">
        <ion-toggle 
          [checked]="isOnline" 
          (ionChange)="toggleOnlineStatus()"
          [color]="isOnline ? 'success' : 'light'"
          [disabled]="isToggling"
          class="online-toggle">
        </ion-toggle>
        <span class="status-text" [class.online]="isOnline" [class.offline]="!isOnline">
          {{ getStatusText() }}
        </span>
      </div>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button (click)="logout()">
        <ion-icon name="log-out" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Historique</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Pull to refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      pullingText="Tirez pour rafra√Æchir"
      refreshingSpinner="circles"
      refreshingText="Chargement...">
    </ion-refresher-content>
  </ion-refresher>

  <!-- Contenu de l'historique des commandes livr√©es -->
  <div class="orders-section">
    <ion-card *ngFor="let order of historyOrders" class="order-card-compact">
      <ion-card-content>
        <!-- Vue compacte par d√©faut -->
        <div class="compact-header">
          <div class="compact-title">
            <strong>#{{ order.order_number }}</strong> ‚Ä¢ üí∞ {{ formatPrice(order.total_amount) }}
          </div>
          <ion-badge [color]="getOrderStatusColor(order.status)" class="compact-badge">
            {{ getOrderStatusText(order.status) }}
          </ion-badge>
        </div>
        
        <div class="compact-client">
          üë§ {{ getCustomerName(order) }}
        </div>
        
        <div class="compact-summary">
          üì¶ {{ orderItemsCounts[order.id] }} article{{ orderItemsCounts[order.id] > 1 ? 's' : '' }} ‚Ä¢ 
          üìç {{ getDeliveryZone(order.delivery_address) }}
        </div>

        <div class="compact-date">
          üìÖ {{ formatDate(order.created_at) }} √† {{ formatTime(order.created_at) }}
        </div>

        <!-- Actions compactes pour l'historique -->
        <div class="compact-actions">
          <ion-button 
            size="small" 
            fill="clear" 
            color="primary"
            (click)="toggleOrderDetail(order)">
            <ion-icon [name]="isOrderExpanded(order) ? 'chevron-up' : 'chevron-down'" slot="start"></ion-icon>
            {{ isOrderExpanded(order) ? 'Masquer' : 'D√©tails' }}
          </ion-button>
        </div>

        <!-- ACCORD√âON D√âTAILS (uniquement si d√©velopp√©) -->
        <div class="order-details-accordion" *ngIf="isOrderExpanded(order)">
          <div class="accordion-divider"></div>
          
          <!-- Contact client - MASQU√â DANS L'HISTORIQUE -->
          <!-- <div class="detail-section">
            <div class="detail-row">
              <div class="detail-actions">
                <ion-button 
                  size="small" 
                  fill="outline" 
                  color="primary"
                  (click)="callCustomer(order.phone_number)">
                  <ion-icon name="call" slot="start"></ion-icon>
                  Appeler
                </ion-button>
              </div>
            </div>
          </div> -->

          <!-- Adresse compl√®te - GPS MASQU√â DANS L'HISTORIQUE -->
          <div class="detail-section" *ngIf="order.delivery_address">
            <div class="detail-row-vertical">
              <span class="address-display">üìç {{ order.delivery_address }}</span>
              <!-- <ion-button 
                size="small" 
                fill="outline" 
                color="success"
                (click)="openDirections(order.delivery_address || '')"
                class="gps-button">
                <ion-icon name="navigate" slot="start"></ion-icon>
                GPS
              </ion-button> -->
            </div>
          </div>

          <!-- D√âTAILS DES ARTICLES - VERSION UNIVERSELLE -->
          <div class="detail-section" *ngIf="orderHasItems[order.id]">
            <div class="detail-label">üì¶ Articles command√©s:</div>
            <div class="order-items">
              <div *ngFor="let formattedItem of orderFormattedItems[order.id]" class="item-card">
                
                <!-- En-t√™te de l'article - FORMAT UNIVERSEL -->
                <div class="item-header">
                  <div class="item-main">
                    <span class="item-quantity">{{ formattedItem.quantity }}x</span>
                    <span class="item-name">
                      {{ formattedItem.productName }}
                      <ion-badge *ngIf="formattedItem.sizeInfo" color="medium" class="size-badge">{{ formattedItem.sizeInfo }}</ion-badge>
                    </span>
                  </div>
                  <span class="item-price">{{ formatPrice(formattedItem.totalPrice) }}</span>
                </div>

                <!-- Pizzas d√©taill√©es du menu (nouveau) -->
                <div class="item-pizza-details" *ngIf="formattedItem.expandedItems && formattedItem.expandedItems.length > 0">
                  <div *ngFor="let pizzaItem of formattedItem.expandedItems" class="pizza-sub-item">
                    <span class="pizza-item-text">{{ pizzaItem }}</span>
                  </div>
                </div>

                <!-- Configuration inline (tags color√©s sous le nom) -->
                <div class="item-inline-config" *ngIf="formattedItem.inlineConfiguration && formattedItem.inlineConfiguration.length > 0">
                  <div class="inline-composition-list">
                    <ion-chip 
                      *ngFor="let config of formattedItem.inlineConfiguration" 
                      color="tertiary" 
                      outline="true"
                      class="composition-chip">
                      {{ config }}
                    </ion-chip>
                  </div>
                </div>

                <!-- Configuration d√©taill√©e avec ic√¥nes (format liste) -->
                <div class="item-detailed-config" *ngIf="formattedItem.formattedConfiguration && formattedItem.formattedConfiguration.length > 0">
                  <div *ngFor="let configLine of formattedItem.formattedConfiguration" class="config-group">
                    <div class="config-group-header">
                      <span class="config-icon">{{ configLine.icon }}</span>
                      <strong>{{ configLine.category }}:</strong>
                    </div>
                    <div class="config-items">
                      <span class="config-value">{{ configLine.value }}</span>
                    </div>
                  </div>
                </div>

                <!-- Items additionnels (boissons, etc.) -->
                <div class="item-additional" *ngIf="formattedItem.additionalItems && formattedItem.additionalItems.length > 0">
                  <div *ngFor="let additionalItem of formattedItem.additionalItems" class="additional-info">
                    <span class="additional-text">{{ additionalItem }}</span>
                  </div>
                </div>

                <!-- Description compl√®te si pr√©sente -->
                <div class="item-description" *ngIf="formattedItem.description" class="item-description">
                  <small class="text-muted">{{ formattedItem.description }}</small>
                </div>

              </div>
            </div>
          </div>

          <!-- Instructions sp√©ciales -->
          <div class="detail-section" *ngIf="order.notes">
            <div class="detail-label">üìù Instructions:</div>
            <div class="notes-content">{{ order.notes }}</div>
          </div>

          <!-- Heure commande -->
          <div class="detail-section">
            <div class="detail-row">
              <span class="detail-label">üïí Command√© √†:</span>
              <span class="time-display">{{ formatTime(order.created_at) }}</span>
            </div>
          </div>

          <!-- Date et heure de livraison R√âELLE (validation livreur) -->
          <div class="detail-section" *ngIf="order.date_validation_code">
            <div class="detail-row">
              <span class="detail-label">‚úÖ Livr√© √†:</span>
              <span class="delivery-time-display">{{ formatTime(order.date_validation_code) }}</span>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Message si pas de commandes dans l'historique - CENTR√â -->
    <div *ngIf="historyOrders.length === 0 && !isLoading" class="empty-state-container">
      <div class="empty-state-content">
        <div class="empty-state-icon">
          <ion-icon name="archive" color="primary"></ion-icon>
        </div>
        <h3 class="empty-state-title">Aucune livraison dans l'historique</h3>
        <p class="empty-state-subtitle">
          Vos livraisons termin√©es appara√Ætront ici.<br>
          Commencez √† livrer pour cr√©er votre historique !
        </p>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-section" *ngIf="isLoading">
    <ion-card>
      <ion-card-content class="text-center">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Chargement de l'historique...</p>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>

<!-- TAB BAR EN BAS - SORTIR DU ION-CONTENT -->
<ion-tab-bar slot="bottom">
  <ion-tab-button 
    routerLink="/restaurant-france/delivery-france/my-orders"
    routerLinkActive="tab-selected">
    <ion-icon name="bicycle"></ion-icon>
    <ion-label>Mes commandes</ion-label>
    <ion-badge 
      *ngIf="currentCounters.myOrdersCount > 0" 
      color="primary" 
      class="tab-badge">
      {{ currentCounters.myOrdersCount }}
    </ion-badge>
  </ion-tab-button>
  
  <ion-tab-button 
    routerLink="/restaurant-france/delivery-france/available-orders"
    routerLinkActive="tab-selected">
    <ion-icon name="notifications"></ion-icon>
    <ion-label>Disponibles</ion-label>
    <ion-badge 
      *ngIf="currentCounters.availableOrdersCount > 0" 
      color="success" 
      class="tab-badge">
      {{ currentCounters.availableOrdersCount }}
    </ion-badge>
  </ion-tab-button>

  <ion-tab-button 
    routerLink="/restaurant-france/delivery-france/history"
    routerLinkActive="tab-selected"
    (click)="refreshHistory()">
    <ion-icon name="archive"></ion-icon>
    <ion-label>Historique</ion-label>
    <ion-badge 
      *ngIf="currentCounters.historyOrdersCount > 0" 
      color="tertiary" 
      class="tab-badge">
      {{ currentCounters.historyOrdersCount }}
    </ion-badge>
  </ion-tab-button>
</ion-tab-bar>
