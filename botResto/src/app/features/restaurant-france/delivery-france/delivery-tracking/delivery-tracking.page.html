<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/restaurant-france/dashboard-france"></ion-back-button>
    </ion-buttons>
    <ion-title>üìä Suivi Livraisons</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="loadTrackingData()">
        <ion-icon name="refresh" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Configuration Green API supprim√©e - d√©j√† configur√©e dans le code -->

  <!-- M√©triques globales modernis√©es -->
  <div class="metrics-container">
    <div class="metrics-grid">
      <div class="metric-card active-orders">
        <div class="metric-icon-wrapper">
          <ion-icon name="restaurant" color="primary"></ion-icon>
        </div>
        <div class="metric-content">
          <h2>{{trackingData.totalActiveOrders}}</h2>
          <p>Commandes actives</p>
        </div>
        <div class="metric-trend" *ngIf="trackingData.totalActiveOrders > 0">
          <ion-icon name="trending-up" color="primary"></ion-icon>
        </div>
      </div>
      
      <div class="metric-card pending-notifications">
        <div class="metric-icon-wrapper">
          <ion-icon name="hourglass" color="warning"></ion-icon>
        </div>
        <div class="metric-content">
          <h2>{{trackingData.totalPendingNotifications}}</h2>
          <p>En attente</p>
        </div>
        <div class="metric-trend" *ngIf="trackingData.totalPendingNotifications > 0">
          <ion-icon name="alert-circle" color="warning"></ion-icon>
        </div>
      </div>
      
      <div class="metric-card response-time">
        <div class="metric-icon-wrapper">
          <ion-icon name="speedometer" color="success"></ion-icon>
        </div>
        <div class="metric-content">
          <h2>{{trackingData.averageResponseTime}}min</h2>
          <p>R√©ponse moyenne</p>
        </div>
        <div class="metric-trend">
          <ion-icon name="checkmark-circle" color="success"></ion-icon>
        </div>
      </div>
    </div>
  </div>

  <!-- Statut Green API supprim√© - d√©j√† configur√© automatiquement -->

  <!-- Loading -->
  <div class="loading-container" *ngIf="isLoading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Chargement des donn√©es...</p>
  </div>

  <!-- Liste des commandes -->
  <div class="orders-container" *ngIf="!isLoading">
    
    <!-- Aucune commande -->
    <ion-item *ngIf="trackingData.activeOrders.length === 0" lines="none" class="empty-state">
      <ion-icon name="checkmark-done-circle" color="success" slot="start"></ion-icon>
      <ion-label>
        <h2>Aucune commande en cours</h2>
        <p>Toutes vos commandes sont livr√©es ou en pr√©paration</p>
      </ion-label>
    </ion-item>

    <!-- Cartes de commandes modernis√©es -->
    <ion-card *ngFor="let order of trackingData.activeOrders" class="order-card modern-card">
      <ion-card-header>
        <div class="order-header">
          <div class="order-info">
            <ion-card-title>
              <div class="status-indicator" [attr.data-status]="order.currentStatus">
                <ion-icon [name]="getStatusIcon(order.currentStatus)" [color]="getStatusColor(order.currentStatus)"></ion-icon>
              </div>
              <span class="order-number">#{{order.orderNumber}}</span>
            </ion-card-title>
            <ion-card-subtitle>
              <ion-chip [color]="getStatusColor(order.currentStatus)" size="small" fill="solid">
                <ion-icon [name]="getStatusIcon(order.currentStatus)" slot="start"></ion-icon>
                {{getStatusText(order.currentStatus)}}
              </ion-chip>
            </ion-card-subtitle>
          </div>
          <div class="order-time" *ngIf="order.lastActionTimestamp">
            <ion-icon name="time-outline" color="medium"></ion-icon>
            <span>{{formatTime24H(order.lastActionTimestamp!)}}</span>
          </div>
        </div>
      </ion-card-header>

      <ion-card-content>
        <!-- Statistiques de la commande -->
        <div class="order-stats">
          <div class="stat-item">
            <ion-icon name="send" color="primary"></ion-icon>
            <span>{{order.notifiedCount}} notifi√©s</span>
          </div>
          <div class="stat-item">
            <ion-icon name="eye" color="medium"></ion-icon>
            <span>{{order.viewedCount}} vus</span>
          </div>
          <div class="stat-item">
            <ion-icon name="close-circle" color="danger"></ion-icon>
            <span>{{order.refusedCount}} refus</span>
          </div>
          <div class="stat-item">
            <ion-icon name="checkmark-circle" color="success"></ion-icon>
            <span>{{order.acceptedCount}} accept√©s</span>
          </div>
        </div>

        <!-- Derni√®re action -->
        <div class="last-action" *ngIf="order.lastActionDriverName && order.lastActionTimestamp">
          <ion-icon name="person-circle" color="medium"></ion-icon>
          <span>
            <strong>{{order.lastActionDriverName}}</strong> 
            - Notification initiale 
            <small>{{getTimeAgo(order.lastActionTimestamp!)}}</small>
          </span>
        </div>

        <!-- Derni√®re mise √† jour des tokens -->
        <div class="token-update" *ngIf="order.lastTokenUpdate">
          <ion-icon name="refresh-circle" color="tertiary"></ion-icon>
          <span>
            Derni√®re mise √† jour (rappels) 
            <small>{{getTimeAgo(order.lastTokenUpdate!)}}</small>
          </span>
        </div>

        <!-- Actions modernis√©es -->
        <div class="order-actions modern-actions">
          
          <!-- Marquer pr√™te (si pas encore pr√™te) -->
          <ion-button 
            *ngIf="order.currentStatus !== 'prete'" 
            expand="block" 
            fill="solid" 
            color="success"
            size="default"
            class="action-button ready-button"
            (click)="markOrderReady(order)">
            <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
            <span>Marquer comme pr√™te</span>
          </ion-button>

          <div class="secondary-actions" *ngIf="order.currentStatus === 'prete'">
            <!-- Rappels (si pr√™te et notifi√©e mais pas accept√©e) -->
            <ion-button 
              *ngIf="order.canSendReminder" 
              fill="outline" 
              color="primary"
              size="default"
              class="action-button reminder-button"
              (click)="sendReminders(order)">
              <ion-icon name="notifications-outline" slot="start"></ion-icon>
              <span>Envoyer rappels</span>
            </ion-button>

            <!-- Force Release (si assign√©e) -->
            <ion-button 
              *ngIf="order.canForceRelease" 
              fill="clear" 
              color="danger"
              size="default"
              class="action-button force-button"
              (click)="forceReleaseOrder(order)">
              <ion-icon name="refresh-circle-outline" slot="start"></ion-icon>
              <span>Force Release</span>
            </ion-button>
          </div>

        </div>
      </ion-card-content>
    </ion-card>
  </div>

</ion-content>