<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/restaurant/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Gestion des commandes</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="manualRefresh()">
        <ion-icon name="refresh" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- NOUVEAU : Banner Abonnement - Version discr√®te -->
  <ion-toolbar *ngIf="subscriptionInfo" [color]="subscriptionInfo.daysRemaining < 0 ? 'danger' : 'light'">
    <ion-title class="ion-text-center" [style.color]="subscriptionInfo.daysRemaining < 0 ? 'white' : '#666'" style="font-size: 13px;">
      <span *ngIf="(subscriptionInfo.status === 'active' || subscriptionInfo.status === 'expiring') && subscriptionInfo.daysRemaining >= 30">
        ‚úÖ Abonnement actif - Expire le {{ subscriptionInfo.endDate | date:'dd/MM/yyyy' }}
      </span>
      <span *ngIf="(subscriptionInfo.status === 'active' || subscriptionInfo.status === 'expiring') && subscriptionInfo.daysRemaining < 30 && subscriptionInfo.daysRemaining >= 0">
        ‚ö†Ô∏è Votre abonnement expire dans {{ subscriptionInfo.daysRemaining }} jours -
        <a [routerLink]="['/restaurant-france/payments-france']" style="color: #333; text-decoration: underline;">Renouveler maintenant</a>
      </span>
      <span *ngIf="subscriptionInfo.status === 'expired'">
        ‚ùå Abonnement expir√© -
        <a [routerLink]="['/restaurant-france/payments-france']" style="color: white; text-decoration: underline;">Renouveler pour continuer</a>
      </span>
    </ion-title>
  </ion-toolbar>

  <!-- Filter tabs -->
  <ion-toolbar>
    <ion-segment [(ngModel)]="selectedFilter" scrollable>
      <ion-segment-button value="all">
        <ion-label>Toutes ({{ getOrderCountByStatus('all') }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="pending">
        <ion-label>En attente ({{ getOrderCountByStatus('pending') }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="confirmee">
        <ion-label>Confirm√©es ({{ getOrderCountByStatus('confirmee') }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="preparation">
        <ion-label>En pr√©paration ({{ getOrderCountByStatus('preparation') }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="prete">
        <ion-label>Pr√™tes ({{ getOrderCountByStatus('prete') }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="en_livraison">
        <ion-label>En livraison ({{ getOrderCountByStatus('en_livraison') }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="historique">
        <ion-label>Historique ({{ getOrderCountByStatus('historique') }})</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Restaurant welcome section -->
  <div class="welcome-section" *ngIf="authService.getCurrentUser()">
    <div class="restaurant-info">
      <ion-icon name="restaurant" class="restaurant-icon"></ion-icon>
      <div class="info-text">
        <h2>{{ authService.getCurrentUser()?.name }}</h2>
        <p>Bienvenue dans votre espace</p>
      </div>
    </div>
  </div>

  <!-- NOUVEAU : Barre de recherche moderne -->
  <div class="search-filter-bar" *ngIf="!isLoading">
    <ion-searchbar 
      [(ngModel)]="searchText"
      placeholder="Rechercher par n¬∞ commande ou t√©l√©phone..."
      debounce="300"
      show-clear-button="focus"
      (ionInput)="onSearchChange($event)"
      (ionClear)="onSearchClear()"
      class="modern-searchbar">
    </ion-searchbar>
    
    <!-- Filtres rapides -->
    <div class="quick-filters" *ngIf="searchText && searchText.length > 0">
      <div class="filter-info">
        <ion-icon name="search" class="search-icon"></ion-icon>
        <span class="results-count">{{ filteredOrdersCount }} r√©sultat{{ filteredOrdersCount !== 1 ? 's' : '' }} sur {{ totalOrdersCount }}</span>
      </div>
      
      <!-- Suggestions de type de recherche -->
      <div class="search-suggestions">
        <ion-chip 
          *ngIf="isPhoneNumber(searchText)" 
          color="secondary" 
          outline
          class="suggestion-chip">
          üìû Num√©ro de t√©l√©phone
        </ion-chip>
        <ion-chip 
          *ngIf="isOrderNumber(searchText)" 
          color="primary" 
          outline
          class="suggestion-chip">
          üìã N¬∞ de commande
        </ion-chip>
      </div>
    </div>
  </div>

  <!-- Loading spinner -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Chargement des commandes...</p>
  </div>

  <!-- Orders list -->
  <div *ngIf="!isLoading">
    <!-- No orders message -->
    <div *ngIf="getFilteredOrders().length === 0">
      <!-- Message diff√©rent si recherche active -->
      <div *ngIf="searchText && searchText.length > 0" class="no-search-results">
        <ion-icon name="search-outline" class="no-results-icon"></ion-icon>
        <div class="no-results-title">Aucun r√©sultat trouv√©</div>
        <div class="no-results-subtitle">
          Aucune commande ne correspond √† "<strong>{{ searchText }}</strong>".<br>
          Essayez de modifier votre recherche ou de v√©rifier l'orthographe.
        </div>
      </div>
      
      <!-- Message par d√©faut si pas de commandes du tout -->
      <ion-card *ngIf="!searchText || searchText.length === 0" class="no-orders-card">
        <ion-card-content>
          <div class="no-orders-content">
            <ion-icon name="receipt-outline" class="no-orders-icon"></ion-icon>
            <h3>Aucune commande</h3>
            <p>Il n'y a aucune commande pour le moment.</p>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Orders cards -->
    <ion-card *ngFor="let order of getFilteredOrders()" class="order-card">
      <ion-card-header>
        <div class="order-header">
          <div class="order-info">
            <ion-card-title>#{{ order.order_number }}</ion-card-title>
            <ion-card-subtitle>{{ order.phone_number }} ‚Ä¢ {{ formatTime(order.created_at) }}</ion-card-subtitle>
          </div>
          <div class="order-badges">
            <ion-badge [color]="getStatusColor(order.status)" class="status-badge">
              {{ getStatusText(order.status) }}
            </ion-badge>
            <ion-badge color="medium" outline *ngIf="order.status !== 'livree' && order.status !== 'annulee' && order.status !== 'servie' && order.status !== 'recuperee'">
              {{ getDeliveryModeText(order.delivery_mode) }}
            </ion-badge>
            <ion-badge color="tertiary" outline *ngIf="order.payment_mode && order.status !== 'livree' && order.status !== 'annulee' && order.status !== 'servie' && order.status !== 'recuperee'">
              {{ getPaymentModeText(order.payment_mode) }}
            </ion-badge>
          </div>
        </div>
      </ion-card-header>

      <ion-card-content>
        <!-- Order items - NOUVELLE VERSION UNIVERSELLE -->
        <div class="order-items">
          <h4>Articles command√©s:</h4>
          <div *ngFor="let formattedItem of getFormattedItems(order)" class="item-card">
            
            <!-- En-t√™te de l'article - FORMAT EXACT rl1.png -->
            <div class="item-header">
              <div class="item-main">
                <span class="item-quantity">{{ formattedItem.quantity }}x</span>
                <span class="item-name">
                  {{ formattedItem.productName }}
                  <ion-badge *ngIf="formattedItem.sizeInfo" color="medium" class="size-badge">{{ formattedItem.sizeInfo }}</ion-badge>
                </span>
              </div>
              <span class="item-price">{{ formatPrice(formattedItem.totalPrice) }}</span>
            </div>

            <!-- Configuration inline (tags color√©s sous le nom) -->
            <div class="item-inline-config" *ngIf="formattedItem.inlineConfiguration && formattedItem.inlineConfiguration.length > 0">
              <div class="inline-composition-list">
                <ion-chip 
                  *ngFor="let config of formattedItem.inlineConfiguration" 
                  color="tertiary" 
                  outline="true"
                  class="composition-chip">
                  {{ config }}
                </ion-chip>
              </div>
            </div>

            <!-- Configuration d√©taill√©e avec ic√¥nes (format liste) -->
            <div class="item-detailed-config" *ngIf="formattedItem.formattedConfiguration && formattedItem.formattedConfiguration.length > 0">
              <div *ngFor="let configLine of formattedItem.formattedConfiguration" class="config-group">
                <div class="config-group-header">
                  <span class="config-icon">{{ configLine.icon }}</span>
                  <strong>{{ configLine.category }}:</strong>
                </div>
                <div class="config-items">
                  <span class="config-value">{{ configLine.value }}</span>
                </div>
              </div>
            </div>

            <!-- Items additionnels (boissons, etc.) -->
            <div class="item-additional" *ngIf="formattedItem.additionalItems && formattedItem.additionalItems.length > 0">
              <div *ngFor="let additionalItem of formattedItem.additionalItems" class="additional-info">
                <span class="additional-text">{{ additionalItem }}</span>
              </div>
            </div>

            <!-- Pizzas d√©taill√©es du menu (nouveau) -->
            <div class="item-pizza-details" *ngIf="formattedItem.expandedItems && formattedItem.expandedItems.length > 0">
              <div *ngFor="let pizzaItem of formattedItem.expandedItems" class="pizza-sub-item">
                <span class="pizza-item-text">{{ pizzaItem }}</span>
              </div>
            </div>

            <!-- Description compl√®te si pr√©sente -->
            <div class="item-description" *ngIf="formattedItem.description" class="item-description">
              <small class="text-muted">{{ formattedItem.description }}</small>
            </div>

          </div>
        </div>

        <!-- Order totals -->
        <div class="order-totals">
          <div class="total-row total-final">
            <span><strong>Total:</strong></span>
            <span><strong>{{ formatPrice(order.total_amount) }}</strong></span>
          </div>
        </div>

        <!-- Order status information -->
        <div class="delivery-info">
          <h4>Informations commande:</h4>
          <p><strong>Cr√©√©e le:</strong> {{ formatDateTime(order.created_at) }}</p>
          <p><strong>Mise √† jour:</strong> {{ formatDateTime(order.updated_at) }}</p>
          <p><strong>Client:</strong> {{ order.phone_number }}</p>
        </div>

        <!-- Delivery information - VERSION ENRICHIE -->
        <div *ngIf="order.delivery_mode === 'livraison'" class="delivery-info">
          <div class="delivery-header">
            <h4>Informations livraison:</h4>
            <!-- Bouton adaptatif selon type d'adresse -->
            <ion-button
              *ngIf="order.delivery_mode === 'livraison' && (order.delivery_address || order.delivery_latitude)"
              fill="solid"
              size="small"
              color="primary"
              class="maps-button"
              (click)="openDrivingDirectionsForOrder(order)">
              <ion-icon name="navigate" slot="start"></ion-icon>
              {{ order.delivery_address_type === 'geolocation' ? 'Voir GPS' : 'Itin√©raire' }}
            </ion-button>
          </div>
          
          <!-- Affichage adaptatif de l'adresse -->
          <p *ngIf="order.delivery_address_type === 'text' && order.delivery_address">
            <strong>Adresse:</strong> {{ order.delivery_address }}
          </p>

          <p *ngIf="order.delivery_address_type === 'geolocation' && order.delivery_latitude">
            <strong>Position GPS:</strong>
            <span class="gps-coords">
              üìç Lat: {{ order.delivery_latitude?.toFixed(6) }},
              Lng: {{ order.delivery_longitude?.toFixed(6) }}
            </span>
          </p>

          <!-- Fallback pour ancienne donn√©es sans type -->
          <p *ngIf="!order.delivery_address_type && order.delivery_address">
            <strong>Adresse:</strong> {{ order.delivery_address }}
          </p>
          <p *ngIf="order.date_validation_code && order.status === 'livree'"><strong>Livr√©e le:</strong> {{ formatDateTime(order.date_validation_code) }}</p>
          <p *ngIf="order.date_validation_code"><strong>Date validation:</strong> {{ formatDateTime(order.date_validation_code) }}</p>
          
          <!-- Informations client enrichies -->
          <div class="customer-info-enriched">
            <p><strong>T√©l√©phone:</strong> {{ order.phone_number }}</p>
            <p *ngIf="order.customer_whatsapp_name" class="whatsapp-name">
              <strong>Client WhatsApp:</strong> 
              <span class="whatsapp-name-display">{{ order.customer_whatsapp_name }}</span>
            </p>
          </div>
          
          
          <!-- NOUVEAU : Statut d'assignation livreur - VERSION MODERNE -->
          <div class="assignment-status" *ngIf="order.status === 'prete' || order.status === 'assignee' || order.status === 'en_livraison'">
            <!-- DEBUG_ASSIGNEE: status={{order.status}} driver_assignment_status={{order.driver_assignment_status}} driver_id={{order.driver_id}} -->
            <div class="driver-info-badge modern" *ngIf="order.driver_id && order.driver_assignment_status === 'assigned'; else noDriverBadge">
                <div class="driver-main-info">
                  <div class="driver-identity">
                    <div class="modern-avatar">
                      <ion-avatar class="driver-avatar">
                        <ion-icon name="person" class="avatar-icon"></ion-icon>
                      </ion-avatar>
                    </div>
                    <div class="driver-name-section">
                      <div class="driver-name">{{ order.pendingDriverNames || 'Livreur assign√©' }}</div>
                      <div class="assignment-status">
                        <ion-icon name="checkmark-circle" color="success" size="small"></ion-icon>
                        <span>Livreur assign√©</span>
                      </div>
                    </div>
                  </div>
                  <div class="driver-contact">
                    <a href="tel:{{ order.phone_number }}" class="phone-button" *ngIf="order.phone_number">
                      <ion-icon name="call" class="phone-icon"></ion-icon>
                      <span class="phone-text">{{ order.phone_number }}</span>
                    </a>
                  </div>
                </div>
                <div class="assignment-meta">
                  <ion-icon name="time-outline" size="small" color="medium"></ion-icon>
                  <span class="assignment-time">Assign√© {{ getNotificationTime(order) }}</span>
                </div>
                <div class="delivery-status" *ngIf="order.delivery_started_at && order.status === 'en_livraison'">
                  <div class="pulse-dot"></div>
                  <span class="status-text">En route depuis {{ franceOrdersService.getDeliveryStartedMinutesAgo(order.delivery_started_at) }} min</span>
                </div>
              </div>
            <ng-template #noDriverBadge>
              <ion-badge color="warning" class="assignment-badge">
                Non assign√©e
              </ion-badge>
            </ng-template>
            
            <!-- NOUVEAU : Gestion intelligente des assignations pending -->
            <div class="notification-status">
              
              <!-- Si assignation pending existe -->
              <div *ngIf="order.hasPendingAssignment" class="pending-assignment-info">
                <div class="notification-info">
                  <ion-icon name="hourglass" color="warning"></ion-icon>
                  <span class="notification-text">
                    ‚è≥ En attente de r√©ponse - {{ order.pendingDriversCount }} livreur(s)
                    <small class="driver-names" *ngIf="order.pendingDriverNames">
                      ({{ order.pendingDriverNames }})
                    </small>
                    <br><small>üì° Notifi√© {{ getNotificationTime(order) }}</small>
                  </span>
                </div>
                
                <!-- Bouton Rappel au lieu de Renvoyer notification -->
                <div class="notification-actions">
                  <ion-button 
                    size="small" 
                    color="primary"
                    fill="solid"
                    class="notification-button"
                    (click)="sendRemindersForOrder(order)">
                    <ion-icon name="notifications" slot="start"></ion-icon>
                    üì® Envoyer rappel
                  </ion-button>
                  
                  <ion-button 
                    size="small" 
                    color="tertiary"
                    fill="clear"
                    class="tracking-button"
                    routerLink="/restaurant-france/delivery-france/tracking">
                    <ion-icon name="analytics" slot="start"></ion-icon>
                    üìä Voir d√©tails tracking ‚Üí
                  </ion-button>
                </div>
              </div>
              
              <!-- Si pas d'assignation pending -->
              <div *ngIf="!order.hasPendingAssignment">
                <div class="notification-info">
                  <ion-icon name="notifications" color="primary"></ion-icon>
                  <span class="notification-text">üì° Notifi√© √† {{ getNotifiedDriversCount(order) }} livreurs - {{ getNotificationTime(order) }}</span>
                </div>
                
                <!-- Boutons d'action normaux -->
                <div class="notification-actions">
                  <!-- Si ANY assignation existe (m√™me expir√©e) ‚Üí Bouton Rappel -->
                  <ion-button 
                    *ngIf="order.hasAnyAssignment"
                    size="small" 
                    color="primary"
                    fill="solid"
                    class="notification-button"
                    (click)="sendRemindersForOrder(order)">
                    <ion-icon name="notifications" slot="start"></ion-icon>
                    üì® Envoyer rappel
                  </ion-button>
                  
                  <!-- Si aucune assignation ‚Üí Bouton Renvoyer notification -->
                  <ion-button 
                    *ngIf="!order.hasAnyAssignment"
                    size="small" 
                    color="warning"
                    fill="outline"
                    class="notification-button"
                    (click)="handleDeliveryOrderReady(order, { key: 'assign', label: 'Assigner', color: 'warning', nextStatus: 'prete' })">
                    <ion-icon name="refresh" slot="start"></ion-icon>
                    üîÑ Renvoyer notification
                  </ion-button>
                  
                  <ion-button 
                    size="small" 
                    color="tertiary"
                    fill="clear"
                    class="tracking-button"
                    routerLink="/restaurant-france/delivery-france/tracking">
                    <ion-icon name="analytics" slot="start"></ion-icon>
                    üìä Voir d√©tails tracking ‚Üí
                  </ion-button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Code de validation livraison - MASQU√â POUR LE RESTAURANT -->
          <!-- Le code est uniquement pour le client via WhatsApp -->
        </div>

        <!-- Dates de finalisation pour tous types de commandes -->
        <div class="completion-dates">
          <p *ngIf="order.updated_at && order.status === 'servie'"><strong>Servie le:</strong> {{ formatDateTime(order.updated_at) }}</p>
          <p *ngIf="order.status === 'recuperee'"><strong>R√©cup√©r√©e le:</strong> {{ formatDateTime(order.updated_at) }}</p>
        </div>

        <!-- Client notes -->
        <div *ngIf="order.notes" class="client-note">
          <h4>Notes:</h4>
          <p class="note-text">{{ order.notes }}</p>
        </div>

        <!-- Additional notes post-order -->
        <div *ngIf="order.additional_notes" class="additional-notes">
          <h4>üí¨ Note ajout√©e apr√®s commande :</h4>
          <p class="note-text">{{ order.additional_notes }}</p>
        </div>

        <!-- Actions -->
        <div class="order-actions">
          <!-- Message clair mode auto activ√© -->
          <ion-chip *ngIf="paymentConfigActive && autoSendEnabled && !isLengoPay" color="success" outline class="auto-mode-chip">
            <ion-icon name="checkmark-circle" slot="start"></ion-icon>
            <ion-label>‚úÖ Lien de paiement envoy√© automatiquement</ion-label>
          </ion-chip>

          <!-- Payment link button - Comportement diff√©rent selon le provider -->
          <!-- Pour LengoPay : toujours visible tant que pas pay√© (m√™me avec mode auto) -->
          <ion-button
            *ngIf="paymentConfigActive && isLengoPay && order.online_payment_status !== 'paid'"
            size="small"
            [color]="order.online_payment_status === 'link_sent' ? 'warning' : 'success'"
            fill="outline"
            (click)="sendPaymentLink(order)">
            <ion-icon name="card-outline" slot="start"></ion-icon>
            {{ order.online_payment_status === 'link_sent' ? 'üîÑ Renvoyer lien' : 'üí≥ Envoyer lien paiement' }}
          </ion-button>

          <!-- Message clair pour LengoPay avec mode auto -->
          <div *ngIf="paymentConfigActive && isLengoPay && autoSendEnabled" class="auto-mode-info">
            <ion-note color="success">
              <ion-icon name="checkmark-circle" size="small"></ion-icon>
              ‚úÖ Lien de paiement envoy√© automatiquement
            </ion-note>
          </div>

          <!-- Pour Stripe : masquer si mode auto activ√©, sinon comportement existant -->
          <ion-button
            *ngIf="paymentConfigActive && !isLengoPay && !autoSendEnabled && (!order.online_payment_status || order.online_payment_status === 'not_sent' || order.online_payment_status === 'failed')"
            size="small"
            color="success"
            fill="outline"
            (click)="sendPaymentLink(order)">
            <ion-icon name="card-outline" slot="start"></ion-icon>
            üí≥ Envoyer lien paiement
          </ion-button>

          <!-- Payment link sent indicator -->
          <ion-chip *ngIf="order.online_payment_status === 'link_sent'" color="warning" class="payment-status-chip">
            <ion-icon name="link-outline"></ion-icon>
            <ion-label>
              üîó Lien envoy√©
              <small *ngIf="order.payment_link_sent_at"> - {{ order.payment_link_sent_at | date:'HH:mm' }}</small>
            </ion-label>
          </ion-chip>

          <!-- Payment status - Visible si paiement effectu√© -->
          <ion-chip *ngIf="order.online_payment_status === 'paid'" color="success">
            <ion-label>
              Pay√© en ligne <small *ngIf="order.payment_date">- {{ order.payment_date | date:'dd/MM HH:mm' }}</small>
            </ion-label>
          </ion-chip>

          <!-- Status update buttons -->
          <div *ngIf="order.availableActions && order.availableActions.length > 0" class="status-actions">
            <ion-button
              *ngFor="let action of order.availableActions"
              size="small"
              [color]="action.color"
              [hidden]="shouldHideActionButton(order, action)"
              (click)="onActionButtonClick(order, action)">
              {{ action.label }}
            </ion-button>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Refresh spinner -->
  <ion-refresher slot="fixed" (ionRefresh)="manualRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
</ion-content>