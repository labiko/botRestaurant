<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/restaurant/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Gestion des commandes</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="manualRefresh()">
        <ion-icon name="refresh" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Filter tabs -->
  <ion-toolbar>
    <ion-segment [(ngModel)]="selectedFilter" scrollable>
      <ion-segment-button value="all">
        <ion-label>Toutes ({{ getOrderCountByStatus('all') }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="en_attente">
        <ion-label>En attente ({{ getOrderCountByStatus('en_attente') }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="confirmee">
        <ion-label>Confirmées ({{ getOrderCountByStatus('confirmee') }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="preparation">
        <ion-label>En préparation ({{ getOrderCountByStatus('preparation') }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="prete">
        <ion-label>Prêtes ({{ getOrderCountByStatus('prete') }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="en_livraison">
        <ion-label>En livraison ({{ getOrderCountByStatus('en_livraison') }})</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Restaurant welcome section -->
  <div class="welcome-section" *ngIf="authService.getCurrentUser()">
    <div class="restaurant-info">
      <ion-icon name="restaurant" class="restaurant-icon"></ion-icon>
      <div class="info-text">
        <h2>{{ authService.getCurrentUser()?.name }}</h2>
        <p>Bienvenue dans votre espace</p>
      </div>
    </div>
  </div>

  <!-- Loading spinner -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Chargement des commandes...</p>
  </div>

  <!-- Orders list -->
  <div *ngIf="!isLoading">
    <!-- No orders message -->
    <ion-card *ngIf="getFilteredOrders().length === 0" class="no-orders-card">
      <ion-card-content>
        <div class="no-orders-content">
          <ion-icon name="receipt-outline" class="no-orders-icon"></ion-icon>
          <h3>Aucune commande</h3>
          <p>Il n'y a aucune commande pour le moment.</p>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Orders cards -->
    <ion-card *ngFor="let order of getFilteredOrders()" class="order-card">
      <ion-card-header>
        <div class="order-header">
          <div class="order-info">
            <ion-card-title>#{{ order.order_number }}</ion-card-title>
            <ion-card-subtitle>{{ order.phone_number }} • {{ formatTime(order.created_at) }}</ion-card-subtitle>
          </div>
          <div class="order-badges">
            <ion-badge [color]="getStatusColor(order.status)" class="status-badge">
              {{ getStatusText(order.status) }}
            </ion-badge>
            <ion-badge color="medium" outline>
              {{ getDeliveryModeText(order.delivery_mode) }}
            </ion-badge>
            <ion-badge color="tertiary" outline *ngIf="order.payment_mode">
              {{ getPaymentModeText(order.payment_mode) }}
            </ion-badge>
          </div>
        </div>
      </ion-card-header>

      <ion-card-content>
        <!-- Order items -->
        <div class="order-items">
          <h4>Articles commandés:</h4>
          <div *ngFor="let item of order.items" class="item-row">
            <span class="item-name">{{ item.quantity || 1 }}x {{ item.name }}</span>
            <span class="item-price">{{ formatPrice(item.total_price || item.price || 0) }}</span>
          </div>
        </div>

        <!-- Order totals -->
        <div class="order-totals">
          <div class="total-row total-final">
            <span><strong>Total:</strong></span>
            <span><strong>{{ formatPrice(order.total_amount) }}</strong></span>
          </div>
        </div>

        <!-- Order status information -->
        <div class="delivery-info">
          <h4>Informations commande:</h4>
          <p><strong>Créée le:</strong> {{ formatDateTime(order.created_at) }}</p>
          <p *ngIf="order.customer_name"><strong>Client:</strong> {{ order.customer_name }}</p>
        </div>

        <!-- Delivery information -->
        <div *ngIf="order.delivery_mode === 'livraison'" class="delivery-info">
          <div class="delivery-header">
            <h4>Informations livraison:</h4>
            <ion-button 
              *ngIf="order.delivery_address"
              fill="solid" 
              size="small" 
              color="primary"
              class="maps-button"
              (click)="openDrivingDirections(0, 0, order.delivery_address)">
              <ion-icon name="navigate" slot="start"></ion-icon>
              Itinéraire
            </ion-button>
          </div>
          <p *ngIf="order.delivery_address"><strong>Adresse:</strong> {{ order.delivery_address }}</p>
          <p><strong>Téléphone:</strong> {{ order.phone_number }}</p>
          
          <!-- Code de validation livraison (SPÉCIFIQUE FRANCE) -->
          <div *ngIf="order.delivery_validation_code" class="validation-code">
            <p><strong>Code validation livraison:</strong> 
              <ion-badge color="warning" class="validation-code-badge">
                {{ order.delivery_validation_code }}
              </ion-badge>
            </p>
            <p *ngIf="!order.date_validation_code" class="validation-status">
              <ion-badge color="medium" outline>
                <ion-icon name="time-outline"></ion-icon>
                En attente validation
              </ion-badge>
            </p>
            <p *ngIf="order.date_validation_code" class="validation-status">
              <ion-badge color="success">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                Validé le {{ formatDateTime(order.date_validation_code) }}
              </ion-badge>
            </p>
          </div>
        </div>

        <!-- Client notes -->
        <div *ngIf="order.notes" class="client-note">
          <h4>Notes:</h4>
          <p class="note-text">{{ order.notes }}</p>
        </div>

        <!-- Actions -->
        <div class="order-actions">
          <!-- Status update buttons -->
          <div *ngIf="order.availableActions && order.availableActions.length > 0" class="status-actions">
            <ion-button 
              *ngFor="let action of order.availableActions"
              size="small" 
              [color]="action.color"
              (click)="onActionButtonClick(order, action)">
              {{ action.label }}
            </ion-button>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Refresh spinner -->
  <ion-refresher slot="fixed" (ionRefresh)="manualRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
</ion-content>