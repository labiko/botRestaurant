<ion-header>
  <ion-toolbar color="primary">
    <ion-title color="light">
      <ion-icon name="cog" slot="start"></ion-icon>
      Configuration du produit: {{ product.name }}
    </ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" color="light" (click)="dismiss()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="modular-config-content">
  <form [formGroup]="configForm" *ngIf="configForm">
    
    <!-- Prix de base -->
    <ion-card class="config-section">
      <ion-card-header>
        <ion-card-title color="primary">
          <ion-icon name="cash" slot="start"></ion-icon>
          Prix de base
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="price-inputs">
          <ion-item fill="outline">
            <ion-label position="stacked">Prix sur place (‚Ç¨)</ion-label>
            <ion-input 
              formControlName="price_on_site_base" 
              type="number" 
              min="0" 
              step="0.10"
              placeholder="0.00">
            </ion-input>
          </ion-item>
          
          <ion-item fill="outline">
            <ion-label position="stacked">Prix livraison (‚Ç¨)</ion-label>
            <ion-input 
              formControlName="price_delivery_base" 
              type="number" 
              min="0" 
              step="0.10"
              placeholder="0.00">
            </ion-input>
          </ion-item>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Navigation Onglets -->
    <div class="tabs-navigation">
      <ion-segment [(ngModel)]="activeTab" [ngModelOptions]="{standalone: true}" (ionChange)="setActiveTab($event.detail.value)" scrollable>
        <ion-segment-button value="sizes">
          <ion-label>üìè Tailles</ion-label>
        </ion-segment-button>
        <ion-segment-button value="drinks">
          <ion-label>ü•§ Boissons</ion-label>
        </ion-segment-button>
        <ion-segment-button value="meats">
          <ion-label>ü•© Viandes</ion-label>
        </ion-segment-button>
        <ion-segment-button value="sauces">
          <ion-label>üå∂Ô∏è Sauces</ion-label>
        </ion-segment-button>
        <ion-segment-button value="options">
          <ion-label>‚öôÔ∏è Options</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Contenu des onglets -->
    
    <!-- Onglet Tailles -->
    <ion-card class="config-section" *ngIf="activeTab === 'sizes'">
      <ion-card-header>
        <div class="section-header">
          <ion-card-title color="warning">
            <ion-icon name="resize" slot="start"></ion-icon>
            üìè Tailles ({{ sizesFormArray.length }})
          </ion-card-title>
          <!-- Bouton Ajouter Menu masqu√© temporairement
          <ion-button fill="outline" color="primary" size="small" (click)="addNewSize()">
            <ion-icon name="add" slot="start"></ion-icon>
            + Ajouter Menu
          </ion-button>
          -->
        </div>
      </ion-card-header>
      <ion-card-content>
        <div formArrayName="sizes">
          <div *ngFor="let sizeForm of sizesFormArray.controls; let i = index" 
               [formGroupName]="i" 
               class="size-item">
            
            <div class="size-header">
              <ion-input 
                formControlName="size_name" 
                placeholder="Nom du menu"
                fill="outline"
                class="size-name-input">
              </ion-input>
              
              <ion-item lines="none" class="size-toggle-item">
                <ion-label>Actif</ion-label>
                <ion-toggle 
                  formControlName="is_active"
                  (ionChange)="onSizeToggleChange(i, $event)"
                  color="success"
                  slot="end">
                </ion-toggle>
              </ion-item>
              
              <!-- Ic√¥ne de suppression masqu√©e temporairement
              <ion-button 
                fill="clear" 
                color="danger" 
                size="small" 
                (click)="removeSize(i)">
                <ion-icon name="trash" slot="icon-only"></ion-icon>
              </ion-button>
              -->
            </div>

            <div class="size-config">
              <ion-item fill="outline">
                <ion-label position="stacked">Prix sur place (‚Ç¨)</ion-label>
                <ion-input 
                  formControlName="price_on_site" 
                  type="number" 
                  min="0" 
                  step="0.10">
                </ion-input>
              </ion-item>
              
              <ion-item fill="outline">
                <ion-label position="stacked">Prix livraison (‚Ç¨)</ion-label>
                <ion-input 
                  formControlName="price_delivery" 
                  type="number" 
                  min="0" 
                  step="0.10">
                </ion-input>
              </ion-item>
              
              <ion-item>
                <ion-checkbox formControlName="includes_drink" slot="start"></ion-checkbox>
                <ion-label>Inclut une boisson</ion-label>
              </ion-item>
            </div>
          </div>
        </div>
        
        <div *ngIf="sizesFormArray.length === 0" class="empty-state">
          <p>Aucune taille configur√©e</p>
          <ion-button fill="outline" color="primary" (click)="addNewSize()">
            <ion-icon name="add" slot="start"></ion-icon>
            + Ajouter Menu
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Onglet Boissons -->
    <ion-card class="config-section" *ngIf="activeTab === 'drinks'">
      <ion-card-header>
        <ion-card-title color="tertiary">
          <ion-icon name="wine" slot="start"></ion-icon>
          ü•§ Configuration Boissons
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="drinks-config">
          <p class="section-description">
            Boissons disponibles pour <strong>{{ product.name }}</strong>
            <span *ngIf="drinkSizes.length > 0"> - Tailles d√©tect√©es: {{ drinkSizes.join(', ') }}</span>
          </p>
          
          <!-- Si aucune taille avec boisson n'est trouv√©e -->
          <div *ngIf="drinkSizes.length === 0" class="no-drinks-info">
            <ion-item color="warning">
              <ion-icon name="warning" slot="start"></ion-icon>
              <ion-label>Aucune taille avec boisson configur√©e pour ce produit</ion-label>
            </ion-item>
          </div>
          
          <!-- Boissons dynamiques bas√©es sur les tailles d√©tect√©es -->
          <div class="drink-types" *ngIf="drinkSizes.length > 0">
            <div *ngFor="let drinkSize of drinkSizes" class="drink-size-group">
              <h4>Boissons {{ drinkSize }}</h4>
              <div *ngFor="let drink of availableDrinks" class="drink-item">
                <ion-item>
                  <ion-checkbox checked="true" slot="start"></ion-checkbox>
                  <ion-label>{{ drink }} {{ drinkSize }}</ion-label>
                </ion-item>
              </div>
            </div>
          </div>
          
          <ion-button fill="outline" color="tertiary" class="add-drink-type" *ngIf="drinkSizes.length > 0">
            <ion-icon name="add" slot="start"></ion-icon>
            Ajouter un type de boisson
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Onglet Viandes -->
    <ion-card class="config-section" *ngIf="activeTab === 'meats'">
      <ion-card-header>
        <ion-card-title color="danger">
          <ion-icon name="nutrition" slot="start"></ion-icon>
          ü•© Viandes & Prot√©ines
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="meats-config">
          <p class="section-description">Configuration des viandes disponibles pour <strong>{{ product.name }}</strong></p>
          
          <div class="meat-items" *ngIf="meatOptions.length > 0">
            <div *ngFor="let meat of meatOptions; let i = index" class="meat-item">
              <ion-item>
                <ion-label>
                  <h3>{{ meat.option_name }}</h3>
                  <p>{{ meat.is_required ? 'Obligatoire' : 'Optionnel' }} - Prix: {{ meat.price_modifier > 0 ? '+' + meat.price_modifier + '‚Ç¨' : 'Inclus' }}</p>
                </ion-label>
                <ion-toggle 
                  [checked]="meat.is_active"
                  (ionChange)="onOptionToggleChange(meat, $event)"
                  color="success"
                  slot="end">
                </ion-toggle>
              </ion-item>
            </div>
          </div>
          
          <div *ngIf="meatOptions.length === 0" class="empty-state">
            <p>Aucune viande configur√©e</p>
          </div>
          
          <!-- Bouton Ajouter une viande masqu√© temporairement
          <ion-button fill="outline" color="danger" class="add-meat-button" (click)="addNewMeat()">
            <ion-icon name="add" slot="start"></ion-icon>
            Ajouter une viande
          </ion-button>
          -->
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Onglet Sauces -->
    <ion-card class="config-section" *ngIf="activeTab === 'sauces'">
      <ion-card-header>
        <ion-card-title color="warning">
          <ion-icon name="water" slot="start"></ion-icon>
          üå∂Ô∏è Sauces & Condiments
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="sauces-config">
          <p class="section-description">Configuration des sauces disponibles pour <strong>{{ product.name }}</strong></p>
          
          <div class="sauce-items" *ngIf="sauceOptions.length > 0">
            <div *ngFor="let sauce of sauceOptions; let i = index" class="sauce-item">
              <ion-item>
                <ion-label>
                  <h3>{{ sauce.option_name }}</h3>
                  <p>{{ sauce.is_required ? 'Obligatoire' : 'Optionnel' }} - Prix: {{ sauce.price_modifier > 0 ? '+' + sauce.price_modifier + '‚Ç¨' : 'Gratuit' }}</p>
                </ion-label>
                <ion-toggle 
                  [checked]="sauce.is_active"
                  (ionChange)="onOptionToggleChange(sauce, $event)"
                  color="success"
                  slot="end">
                </ion-toggle>
              </ion-item>
            </div>
          </div>
          
          <div *ngIf="sauceOptions.length === 0" class="empty-state">
            <p>Aucune sauce configur√©e</p>
          </div>
          
          <!-- Bouton Ajouter une sauce masqu√© temporairement
          <ion-button fill="outline" color="warning" class="add-sauce-button" (click)="addNewSauce()">
            <ion-icon name="add" slot="start"></ion-icon>
            Ajouter une sauce
          </ion-button>
          -->
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Onglet Options -->
    <ion-card class="config-section" *ngIf="activeTab === 'options'">
      <ion-card-header>
        <div class="section-header">
          <ion-card-title color="secondary">
            <ion-icon name="options" slot="start"></ion-icon>
            ‚öôÔ∏è Autres Options ({{ otherOptions.length }})
          </ion-card-title>
          <!-- Bouton masqu√© temporairement
          <ion-button fill="outline" color="secondary" size="small" (click)="addNewOption()">
            <ion-icon name="add" slot="start"></ion-icon>
            Ajouter Option
          </ion-button>
          -->
        </div>
      </ion-card-header>
      <ion-card-content>
        <div class="options-summary">
          <div class="option-group-info">
            <p><strong>L√©gumes & Accompagnements:</strong> Salade, Tomates, Oignons, Frites, Suppl√©ment Fromage</p>
          </div>
        </div>
        
        <div class="other-options-list">
          <div *ngFor="let option of otherOptions; let i = index" class="option-item">
            <ion-item>
              <ion-checkbox [checked]="option.is_active" slot="start"></ion-checkbox>
              <ion-label>
                <h3>{{ option.option_name }}</h3>
                <p>
                  Groupe: {{ option.option_group }} - 
                  {{ option.is_required ? 'Obligatoire' : 'Optionnel' }} - 
                  Prix: {{ option.price_modifier > 0 ? '+' + option.price_modifier + '‚Ç¨' : 'Inclus' }}
                </p>
              </ion-label>
              <!-- Ic√¥ne d'√©dition masqu√©e temporairement
              <ion-button fill="clear" color="medium" slot="end">
                <ion-icon name="create" slot="icon-only"></ion-icon>
              </ion-button>
              -->
            </ion-item>
          </div>
        </div>
        
        <div *ngIf="otherOptions.length === 0" class="empty-state">
          <p>Aucune option configur√©e</p>
          <ion-button fill="outline" color="secondary" (click)="addNewOption()">
            <ion-icon name="add" slot="start"></ion-icon>
            Ajouter la premi√®re option
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

  </form>
</ion-content>

<ion-footer>
  <ion-toolbar>
    <div class="footer-actions">
      <ion-button 
        expand="block" 
        color="primary" 
        [disabled]="isLoading || !configForm.valid"
        (click)="saveConfiguration()">
        <ion-icon name="save" slot="start" *ngIf="!isLoading"></ion-icon>
        <ion-spinner name="circular" slot="start" *ngIf="isLoading"></ion-spinner>
        {{ isLoading ? 'Sauvegarde...' : 'Sauvegarder la configuration' }}
      </ion-button>
    </div>
  </ion-toolbar>
</ion-footer>